!function(t,n){"object"==typeof exports&&"object"==typeof module?module.exports=n():"function"==typeof define&&define.amd?define("vdp-lib",[],n):"object"==typeof exports?exports["vdp-lib"]=n():t["vdp-lib"]=n()}(window,function(){return function(t){var n={};function r(e){if(n[e])return n[e].exports;var i=n[e]={i:e,l:!1,exports:{}};return t[e].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=t,r.c=n,r.d=function(t,n,e){r.o(t,n)||Object.defineProperty(t,n,{enumerable:!0,get:e})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"u",{value:!0})},r.t=function(t,n){if(1&n&&(t=r(t)),8&n)return t;if(4&n&&"object"==typeof t&&t&&t.u)return t;var e=Object.create(null);if(r.r(e),Object.defineProperty(e,"default",{enumerable:!0,value:t}),2&n&&"string"!=typeof t)for(var i in t)r.d(e,i,function(n){return t[n]}.bind(null,i));return e},r.n=function(t){var n=t&&t.u?function(){return t.default}:function(){return t};return r.d(n,"a",n),n},r.o=function(t,n){return Object.prototype.hasOwnProperty.call(t,n)},r.p="",r(r.s=10)}([function(t,n,r){"use strict";var e,i;r.d(n,"i",function(){return e}),r.d(n,"h",function(){return i}),r.d(n,"b",function(){return a}),r.d(n,"a",function(){return u}),r.d(n,"g",function(){return h}),r.d(n,"j",function(){return s}),r.d(n,"e",function(){return l}),r.d(n,"d",function(){return v}),r.d(n,"c",function(){return M}),r.d(n,"k",function(){return p}),r.d(n,"f",function(){return m}),r.d(n,"o",function(){return x}),r.d(n,"l",function(){return w}),r.d(n,"s",function(){return y}),r.d(n,"r",function(){return _}),r.d(n,"t",function(){return b}),r.d(n,"q",function(){return g}),r.d(n,"n",function(){return S}),r.d(n,"m",function(){return O}),r.d(n,"p",function(){return C});var o,a=1024,u=1024,f=1024,c=1024,h=256,s=!1,l=2048,v=16,M=12,p=!0,d=!0,m=32768,x=[1,1,1,1],w=[-1,-1,-1,-1];function y(t,n,r){void 0===r&&(r=!1),e=t,i=n,s=r}function _(t,n){o=t,h=n}function b(t,n){f=t,c=n}function g(t,n){a=t,u=n}function S(){var t="float("+255/256*(256/o)+")",n="float("+16/o/16+")";return"\nfloat readTexel8(float x, float y) {\n\tint texelId = int(x / 4.0);\n\tvec4 read = texture2D(uSamplerSprites, vec2(float(texelId) / "+f+".0, y / "+c+".0));\n\tint texelC = int(x) - texelId * 4;\n\tif (texelC == 0) return read.r * "+t+";\n\tif (texelC == 1) return read.g * "+t+";\n\tif (texelC == 2) return read.b * "+t+";\n\treturn read.a * "+t+";\n}\n\nfloat extractTexelHi(float colorComp) {\n\tint intValue = int(colorComp * 255.0);\n\treturn float(intValue / 16) * "+n+";\n}\n\nfloat extractTexelLo(float colorComp) {\n\tint intValue = int(colorComp * 255.0);\n\treturn float(intValue - (intValue / 16) * 16) * "+n+";\n\t//return float(mod(float(intValue), 16.0)) * "+n+";\n}\n\nfloat readTexel4(float x, float y) {\n\tint texelId = int(x / 8.0);\n\tvec4 read = texture2D(uSamplerSprites, vec2(float(texelId) / "+f+".0, y / "+c+".0));\n\tint texelC = int(x) - texelId * 8;\n\t\n\tif (texelC == 0) return extractTexelHi(read.r);\n\tif (texelC == 1) return extractTexelLo(read.r);\n\tif (texelC == 2) return extractTexelHi(read.g);\n\tif (texelC == 3) return extractTexelLo(read.g);\n\tif (texelC == 4) return extractTexelHi(read.b);\n\tif (texelC == 5) return extractTexelLo(read.b);\n\tif (texelC == 6) return extractTexelHi(read.a);\n\treturn extractTexelLo(read.a);\n\t//return 9.0 * "+n+";\n}"}function O(t){return void 0===t&&(t=!0),"vec4 readColorSwapBuffer(int bufferNo, float horizOffset) {\n\tvec4 read = texture2D(uSamplerOthers, vec2(("+i+".0 - horizOffset) / "+l+".0, float(bufferNo) / "+v+".0));\n\treturn vec4(read.xyz, 1.0);\n}\n\nvec4 readPalette(highp float x, highp float y) {\n\thighp float index = x * "+o+".0 + (y * "+h+".0) * 256.0;\n\t"+(t?"if (x < "+1/o+") discard;":"")+"\n\tif (index == uColorSwaps[0]) return readColorSwapBuffer("+M+", gl_FragCoord.y);\n\tif (index == uColorSwaps[1]) return readColorSwapBuffer("+(M+1)+", gl_FragCoord.y);\n\tif (index == uColorSwaps[2]) return readColorSwapBuffer("+(M+2)+", gl_FragCoord.y);\n\tif (index == uColorSwaps[3]) return readColorSwapBuffer("+(M+3)+", gl_FragCoord.y);\n\treturn texture2D(uSamplerPalettes, vec2(x, y));\n}"}function C(t){return d?"vec4(("+t+").rgb * uEnvColor.rgb, 1)":t+" * uEnvColor"}},function(t,n,r){"use strict";r.d(n,"a",function(){return e});var e=function(){function t(){}return t.extract=function(n,r){return void 0===r&&(r=8),{a:(n=t.posterize(n,r))>>>24,b:n>>>16&255,g:n>>>8&255,r:255&n}},t.make=function(t,n,r,e){if("number"==typeof t)return"number"!=typeof e&&(e=255),"number"!=typeof r?t:Math.ceil(Math.max(0,Math.min(255,t)))|Math.ceil(Math.max(0,Math.min(255,n)))<<8|Math.ceil(Math.max(0,Math.min(255,r)))<<16|Math.ceil(Math.max(0,Math.min(255,e)))<<24;if("string"==typeof t)switch("#"!==t.charAt(0)&&(t=""),t.length){case 4:return t=parseInt(t.substring(1),16),this.extendColor12(t<<4|15);case 5:return t=parseInt(t.substring(1),16),this.extendColor12(t);case 7:return t=parseInt(t.substring(1),16),this.reversecolor(t<<8|255);case 9:return t=parseInt(t.substring(1),16),this.reversecolor(t);default:throw new Error("Invalid color string "+t)}return this.make(t.r,t.g,t.b,t.a)},t.makeFromFloat=function(t,n,r,e){return void 0===e&&(e=1),this.make(255*t,255*n,255*r,255*e)},t.makeFromHsl=function(t){var n,r,e;if(0==t.s)n=r=e=t.l;else{function i(t,n,r){return(r-=Math.floor(r))<1/6?t+6*(n-t)*r:r<.5?n:r<2/3?t+(n-t)*(2/3-r)*6:t}var o=t.l<.5?t.l*(1+t.s):t.l+t.s-t.l*t.s,a=2*t.l-o;n=i(a,o,t.h+1/3),r=i(a,o,t.h),e=i(a,o,t.h-1/3)}return this.make(255*n,255*r,255*e)},t.extendColor12=function(n){return t.reversecolor(15&n|(15&n)<<4|(240&n)<<4|(240&n)<<8|(3840&n)<<8|(3840&n)<<12|(61440&n)<<12|(61440&n)<<16)},t.posterize=function(t,n){if(2===n){var r=t>>>6&16843009|t>>>7&16843009;return(r|=r<<1)|r<<2|(t=t>>>6&50529027)<<4|t<<6}if(3===n){r=t>>>6&50529027;return(t=t>>>5&117901063)|t<<5|t<<2|r}if(4===n)return(t=t>>>4&252645135)|t<<4;if(5===n){r=t>>>5&117901063;return(t=t>>>3&522133279)<<3|r}return t},t.reversecolor=function(t){return(255&t)<<24|(t>>>8&255)<<16|(t>>>16&255)<<8|t>>>24&255},t.toHsl=function(t){var n,r,e=this.extract(t),i=e.r/255,o=e.g/255,a=e.b/255,u=Math.max(i,o,a),f=Math.min(i,o,a),c=(u+f)/2;if(u==f)n=r=0;else{var h=u-f;switch(r=c>.5?h/(2-u-f):h/(u+f),u){case i:n=(o-a)/h+(o<a?6:0);break;case o:n=(a-i)/h+2;break;case a:n=(i-o)/h+4}n/=6}return{h:n,s:r,l:c}},t.add=function(t,n){var r=(t>>>24)+(n>>>24),e=(t>>>16&255)+(n>>>16&255),i=(t>>>8&255)+(n>>>8&255),o=(255&t)+(255&n);return r>255&&(r=255),e>255&&(e=255),i>255&&(i=255),o>255&&(o=255),o|i<<8|e<<16|r<<24},t.sub=function(t,n){var r=(t>>>24)-(n>>>24),e=(t>>>16&255)-(n>>>16&255),i=(t>>>8&255)-(n>>>8&255),o=(255&t)-(255&n);return r<0&&(r=0),e<0&&(e=0),i<0&&(i=0),o<0&&(o=0),o|i<<8|e<<16|r<<24},t.mul=function(t,n){return(255&t)*(255&n)/255|(t>>>8&255)*(n>>>8&255)/255<<8|(t>>>16&255)*(n>>>16&255)/255<<16|(t>>>24)*(n>>>24)/255<<24},t.blend=function(t,n,r){var e=1-(r=Math.min(1,Math.max(0,r)));return(255&t)*e+(255&n)*r|(t>>>8&255)*e+(n>>>8&255)*r<<8|(t>>>16&255)*e+(n>>>16&255)*r<<16|(t>>>24)*e+(n>>>24)*r<<24},t}()},function(t,n,r){"use strict";var e={};r.r(e),r.d(e,"create",function(){return k}),r.d(e,"fromMat4",function(){return N}),r.d(e,"clone",function(){return V}),r.d(e,"copy",function(){return q}),r.d(e,"fromValues",function(){return R}),r.d(e,"set",function(){return W}),r.d(e,"identity",function(){return X}),r.d(e,"transpose",function(){return G}),r.d(e,"invert",function(){return K}),r.d(e,"adjoint",function(){return Y}),r.d(e,"determinant",function(){return H}),r.d(e,"multiply",function(){return J}),r.d(e,"translate",function(){return Q}),r.d(e,"rotate",function(){return Z}),r.d(e,"scale",function(){return $}),r.d(e,"fromTranslation",function(){return tt}),r.d(e,"fromRotation",function(){return nt}),r.d(e,"fromScaling",function(){return rt}),r.d(e,"fromMat2d",function(){return et}),r.d(e,"fromQuat",function(){return it}),r.d(e,"normalFromMat4",function(){return ot}),r.d(e,"projection",function(){return at}),r.d(e,"str",function(){return ut}),r.d(e,"frob",function(){return ft}),r.d(e,"add",function(){return ct}),r.d(e,"subtract",function(){return ht}),r.d(e,"multiplyScalar",function(){return st}),r.d(e,"multiplyScalarAndAdd",function(){return lt}),r.d(e,"exactEquals",function(){return vt}),r.d(e,"equals",function(){return Mt}),r.d(e,"mul",function(){return pt}),r.d(e,"sub",function(){return dt});var i={};r.r(i),r.d(i,"create",function(){return mt}),r.d(i,"clone",function(){return xt}),r.d(i,"copy",function(){return wt}),r.d(i,"fromValues",function(){return yt}),r.d(i,"set",function(){return _t}),r.d(i,"identity",function(){return bt}),r.d(i,"transpose",function(){return gt}),r.d(i,"invert",function(){return St}),r.d(i,"adjoint",function(){return Ot}),r.d(i,"determinant",function(){return Ct}),r.d(i,"multiply",function(){return Tt}),r.d(i,"translate",function(){return Pt}),r.d(i,"scale",function(){return It}),r.d(i,"rotate",function(){return Et}),r.d(i,"rotateX",function(){return At}),r.d(i,"rotateY",function(){return zt}),r.d(i,"rotateZ",function(){return jt}),r.d(i,"fromTranslation",function(){return Dt}),r.d(i,"fromScaling",function(){return Bt}),r.d(i,"fromRotation",function(){return Ft}),r.d(i,"fromXRotation",function(){return Lt}),r.d(i,"fromYRotation",function(){return Ut}),r.d(i,"fromZRotation",function(){return kt}),r.d(i,"fromRotationTranslation",function(){return Nt}),r.d(i,"fromQuat2",function(){return Vt}),r.d(i,"getTranslation",function(){return qt}),r.d(i,"getScaling",function(){return Rt}),r.d(i,"getRotation",function(){return Wt}),r.d(i,"fromRotationTranslationScale",function(){return Xt}),r.d(i,"fromRotationTranslationScaleOrigin",function(){return Gt}),r.d(i,"fromQuat",function(){return Kt}),r.d(i,"frustum",function(){return Yt}),r.d(i,"perspective",function(){return Ht}),r.d(i,"perspectiveFromFieldOfView",function(){return Jt}),r.d(i,"ortho",function(){return Qt}),r.d(i,"lookAt",function(){return Zt}),r.d(i,"targetTo",function(){return $t}),r.d(i,"str",function(){return tn}),r.d(i,"frob",function(){return nn}),r.d(i,"add",function(){return rn}),r.d(i,"subtract",function(){return en}),r.d(i,"multiplyScalar",function(){return on}),r.d(i,"multiplyScalarAndAdd",function(){return an}),r.d(i,"exactEquals",function(){return un}),r.d(i,"equals",function(){return fn}),r.d(i,"mul",function(){return cn}),r.d(i,"sub",function(){return hn});var o={};r.r(o),r.d(o,"create",function(){return sn}),r.d(o,"clone",function(){return ln}),r.d(o,"fromValues",function(){return vn}),r.d(o,"copy",function(){return Mn}),r.d(o,"set",function(){return pn}),r.d(o,"add",function(){return dn}),r.d(o,"subtract",function(){return mn}),r.d(o,"multiply",function(){return xn}),r.d(o,"divide",function(){return wn}),r.d(o,"ceil",function(){return yn}),r.d(o,"floor",function(){return _n}),r.d(o,"min",function(){return bn}),r.d(o,"max",function(){return gn}),r.d(o,"round",function(){return Sn}),r.d(o,"scale",function(){return On}),r.d(o,"scaleAndAdd",function(){return Cn}),r.d(o,"distance",function(){return Tn}),r.d(o,"squaredDistance",function(){return Pn}),r.d(o,"length",function(){return In}),r.d(o,"squaredLength",function(){return En}),r.d(o,"negate",function(){return An}),r.d(o,"inverse",function(){return zn}),r.d(o,"normalize",function(){return jn}),r.d(o,"dot",function(){return Dn}),r.d(o,"cross",function(){return Bn}),r.d(o,"lerp",function(){return Fn}),r.d(o,"random",function(){return Ln}),r.d(o,"transformMat2",function(){return Un}),r.d(o,"transformMat2d",function(){return kn}),r.d(o,"transformMat3",function(){return Nn}),r.d(o,"transformMat4",function(){return Vn}),r.d(o,"rotate",function(){return qn}),r.d(o,"angle",function(){return Rn}),r.d(o,"zero",function(){return Wn}),r.d(o,"str",function(){return Xn}),r.d(o,"exactEquals",function(){return Gn}),r.d(o,"equals",function(){return Kn}),r.d(o,"len",function(){return Hn}),r.d(o,"sub",function(){return Jn}),r.d(o,"mul",function(){return Qn}),r.d(o,"div",function(){return Zn}),r.d(o,"dist",function(){return $n}),r.d(o,"sqrDist",function(){return tr}),r.d(o,"sqrLen",function(){return nr}),r.d(o,"forEach",function(){return rr});var a=null,u=null,f=function(){return function(t,n){this.texture=t,this.width=n.width,this.height=n.height}}();function c(t,n,r){var e=t.createShader(n);return t.shaderSource(e,r),t.compileShader(e),t.getShaderParameter(e,t.COMPILE_STATUS)?e:(alert("An error occurred compiling the shaders: "+t.getShaderInfoLog(e)),t.deleteShader(e),null)}function h(t,n,r){var e=c(t,t.VERTEX_SHADER,n),i=c(t,t.FRAGMENT_SHADER,r),o=t.createProgram();return t.attachShader(o,e),t.attachShader(o,i),t.linkProgram(o),t.getProgramParameter(o,t.LINK_STATUS)?o:(alert("Unable to initialize the shader program: "+t.getProgramInfoLog(o)),null)}function s(t,n){var r=t.createTexture(),e=new Image;return t.bindTexture(t.TEXTURE_2D,r),new Promise(function(i){e.onload=function(){return t.bindTexture(t.TEXTURE_2D,r),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),i(new f(r,e))},e.src=n})}function l(t){return t.createBuffer()}function v(t,n){u||(u=t.createFramebuffer()),n?(t.bindFramebuffer(t.FRAMEBUFFER,u),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,n,0)):t.bindFramebuffer(t.FRAMEBUFFER,null)}function M(t,n,r,e,i,o){var a=new Uint8Array(i*o*4);return v(t,n),t.readPixels(r,e,i,o,t.RGBA,t.UNSIGNED_BYTE,a),v(t,null),a}function p(t,n,r,e,i,o,a){t.bindTexture(t.TEXTURE_2D,n),t.texSubImage2D(t.TEXTURE_2D,0,r,e,i,o,t.RGBA,t.FLOAT,a)}function d(t,n){return[].concat.apply([],[t.slice(0,n),t.slice(n,2*n),t.slice(3*n,4*n),t.slice(0,1*n),t.slice(3*n,4*n),t.slice(2*n,3*n)])}var m=r(0),x=function(t,n){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var e,i,o=r.call(t),a=[];try{for(;(void 0===n||n-- >0)&&!(e=o.next()).done;)a.push(e.value)}catch(t){i={error:t}}finally{try{e&&!e.done&&(r=o.return)&&r.call(o)}finally{if(i)throw i.error}}return a},w=6,y=function(){function t(t,n){this.usedVertices=0,this.name=t,this.xyzp=new Float32Array(4*n),this.uv=new Float32Array(2*n),this.maxVertices=n}return Object.defineProperty(t.prototype,"firstSprite",{get:function(){return this.firstVertice/w},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"firstVertice",{get:function(){return this.maxVertices-this.usedVertices},enumerable:!0,configurable:!0}),t.prototype.getZOfObject=function(t){return this.xyzp[4*w*t+2]},t.prototype.sort=function(t){var n,r,e=this,i=(n=this.firstVertice/w,r=this.usedVertices/w,Array.from({length:r},function(t,r){return n+r}));i.sort(function(t,n){return e.getZOfObject(n)-e.getZOfObject(t)});for(var o=i.length,a=0;a<i.length;a++)if(this.getZOfObject(i[a])<=t){o=a;break}var u=this.xyzp.slice(),f=this.uv.slice(),c=this.firstSprite;for(a=0;a<i.length;a++)this.xyzp.set(u.subarray(4*w*i[a],4*w*(i[a]+1)),4*w*(a+c)),this.uv.set(f.subarray(2*w*i[a],2*w*(i[a]+1)),2*w*(a+c));return o},t.prototype.reset=function(){this.usedVertices=0},Object.defineProperty(t.prototype,"usedSprites",{get:function(){return this.usedVertices/w},enumerable:!0,configurable:!0}),t}();function _(t,n,r,e,i){var o,a;return void 0===i&&(i=!1),t=Math.max(0,Math.min(m.i,t)),r=Math.max(0,Math.min(m.i,r)),n=Math.max(0,Math.min(m.i,n)),e=Math.max(0,Math.min(m.i,e)),t>r&&(r=(o=x([t,r],2))[0],t=o[1]),n>e&&(e=(a=x([n,e],2))[0],n=a[1]),i?Math.ceil((r-t)/sr)*Math.ceil((e-n)/sr):(r-t)*(e-n)}function b(t,n,r,e){if(!(e<=r)){var i=t.M,o=t._,a=n.firstVertice;o.bindBuffer(o.ARRAY_BUFFER,i.glBuffers.xyzp),o.bufferData(o.ARRAY_BUFFER,n.xyzp.subarray(4*a),o.STREAM_DRAW),o.bindBuffer(o.ARRAY_BUFFER,i.glBuffers.uv),o.bufferData(o.ARRAY_BUFFER,n.uv.subarray(2*a),o.STREAM_DRAW),o.useProgram(i.program);var u=o.FLOAT,f=!1,c=0,h=0;o.bindBuffer(o.ARRAY_BUFFER,i.glBuffers.xyzp),o.vertexAttribPointer(i.attribLocations.xyzp,4,u,f,c,h),o.enableVertexAttribArray(i.attribLocations.xyzp);u=o.FLOAT,f=!1,c=0,h=0;o.bindBuffer(o.ARRAY_BUFFER,i.glBuffers.uv),o.vertexAttribPointer(i.attribLocations.uv,2,u,f,c,h),o.enableVertexAttribArray(i.attribLocations.uv),o.activeTexture(o.TEXTURE0),o.bindTexture(o.TEXTURE_2D,t.S),o.activeTexture(o.TEXTURE1),o.bindTexture(o.TEXTURE_2D,t.O),o.activeTexture(o.TEXTURE3),o.bindTexture(o.TEXTURE_2D,t.C),o.uniform1i(i.uniformLocations.uSamplerSprites,0),o.uniform1i(i.uniformLocations.uSamplerPalettes,1),o.uniform1i(i.uniformLocations.uSamplerOthers,3),o.uniformMatrix4fv(i.uniformLocations.projectionMatrix,!1,t.T),o.uniformMatrix3fv(i.uniformLocations.modelViewMatrix,!1,t.P),o.uniform4f(i.uniformLocations.envColor,m.o[0],m.o[1],m.o[2],m.o[3]),o.uniform4f(i.uniformLocations.colorSwaps,m.l[0],m.l[1],m.l[2],m.l[3]),o.drawArrays(o.TRIANGLES,r*w,(e-r)*w)}}function g(t,n,r,e,i,o,a,u,f,c,h,s,l,v){var M,p;if(void 0===s&&(s=0),void 0===l&&(l=!1),void 0===v&&(v=!1),h&&(c|=m.f),t.usedVertices>=t.maxVertices)fr&&console.log(t.name+" overuse (max "+t.maxVertices/w+"), ignoring drawOBJ");else{t.usedVertices+=w;var y=t.firstVertice;l&&(o=(M=x([u,o],2))[0],u=M[1]),v&&(a=(p=x([f,a],2))[0],f=p[1]),t.xyzp.set(d([n,r,s,c,e,r,s,c,n,i,s,c,e,i,s,c],4),4*y),t.uv.set(d([o,a,u,a,o,f,u,f],2),2*y)}}function S(t,n){return new y(t,n*w)}var O=6,C=function(){function t(t,n){this.usedVertices=0,this.name=t,this.xyzp=new Float32Array(4*n),this.mapInfo1=new Float32Array(4*n),this.mapInfo2=new Float32Array(4*n),this.mapInfo3=new Float32Array(4*n),this.mapInfo4=new Float32Array(4*n),this.maxVertices=n}return Object.defineProperty(t.prototype,"firstVertice",{get:function(){return this.maxVertices-this.usedVertices},enumerable:!0,configurable:!0}),t.prototype.getZOfBG=function(t){return this.xyzp[this.firstVertice+4*O*t+2]},Object.defineProperty(t.prototype,"usedLayers",{get:function(){return this.usedVertices/O},enumerable:!0,configurable:!0}),t}();function T(t,n){if(!(n.usedVertices<3)){var r=t._,e=t.I,i=n.firstVertice;r.bindBuffer(r.ARRAY_BUFFER,e.glBuffers.xyzp),r.bufferData(r.ARRAY_BUFFER,n.xyzp.subarray(4*i),r.STREAM_DRAW),r.bindBuffer(r.ARRAY_BUFFER,e.glBuffers.mapInfo1),r.bufferData(r.ARRAY_BUFFER,n.mapInfo1.subarray(4*i),r.STREAM_DRAW),r.bindBuffer(r.ARRAY_BUFFER,e.glBuffers.mapInfo2),r.bufferData(r.ARRAY_BUFFER,n.mapInfo2.subarray(4*i),r.STREAM_DRAW),r.bindBuffer(r.ARRAY_BUFFER,e.glBuffers.mapInfo3),r.bufferData(r.ARRAY_BUFFER,n.mapInfo3.subarray(4*i),r.STREAM_DRAW),r.bindBuffer(r.ARRAY_BUFFER,e.glBuffers.mapInfo4),r.bufferData(r.ARRAY_BUFFER,n.mapInfo4.subarray(4*i),r.STREAM_DRAW),r.useProgram(e.program);var o=r.FLOAT,a=!1,u=0,f=0;r.bindBuffer(r.ARRAY_BUFFER,e.glBuffers.xyzp),r.vertexAttribPointer(e.attribLocations.xyzp,4,o,a,u,f),r.enableVertexAttribArray(e.attribLocations.xyzp);var c=4;o=r.FLOAT,a=!1,u=0,f=0;r.bindBuffer(r.ARRAY_BUFFER,e.glBuffers.mapInfo1),r.vertexAttribPointer(e.attribLocations.mapInfo1,c,o,a,u,f),r.enableVertexAttribArray(e.attribLocations.mapInfo1);c=4,o=r.FLOAT,a=!1,u=0,f=0;r.bindBuffer(r.ARRAY_BUFFER,e.glBuffers.mapInfo2),r.vertexAttribPointer(e.attribLocations.mapInfo2,c,o,a,u,f),r.enableVertexAttribArray(e.attribLocations.mapInfo2);c=4,o=r.FLOAT,a=!1,u=0,f=0;r.bindBuffer(r.ARRAY_BUFFER,e.glBuffers.mapInfo3),r.vertexAttribPointer(e.attribLocations.mapInfo3,c,o,a,u,f),r.enableVertexAttribArray(e.attribLocations.mapInfo3);c=4,o=r.FLOAT,a=!1,u=0,f=0;r.bindBuffer(r.ARRAY_BUFFER,e.glBuffers.mapInfo4),r.vertexAttribPointer(e.attribLocations.mapInfo4,c,o,a,u,f),r.enableVertexAttribArray(e.attribLocations.mapInfo4),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,t.S),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,t.O),r.activeTexture(r.TEXTURE2),r.bindTexture(r.TEXTURE_2D,t.D),r.activeTexture(r.TEXTURE3),r.bindTexture(r.TEXTURE_2D,t.C),r.uniform1i(e.uniformLocations.uSamplerSprites,0),r.uniform1i(e.uniformLocations.uSamplerPalettes,1),r.uniform1i(e.uniformLocations.uSamplerMaps,2),r.uniform1i(e.uniformLocations.uSamplerOthers,3),r.uniformMatrix4fv(e.uniformLocations.projectionMatrix,!1,t.T),r.uniformMatrix3fv(e.uniformLocations.modelViewMatrix,!1,t.P),r.uniform4f(e.uniformLocations.envColor,m.o[0],m.o[1],m.o[2],m.o[3]),r.uniform4f(e.uniformLocations.colorSwaps,m.l[0],m.l[1],m.l[2],m.l[3]),r.drawArrays(r.TRIANGLES,0,n.usedVertices),n.usedVertices=0}}function P(t,n){return new C(t,n*O)}function I(t,n,r,e,i,o,a,u,f){var c=t._,h=t.F,s=[n,r,e,r,n,i,e,i],l=[o,a,u,f,o,a,u,f,o,a,u,f,o,a,u,f];c.bindBuffer(c.ARRAY_BUFFER,h.glBuffers.xy),c.bufferData(c.ARRAY_BUFFER,new Float32Array(s),c.STREAM_DRAW),c.bindBuffer(c.ARRAY_BUFFER,h.glBuffers.color),c.bufferData(c.ARRAY_BUFFER,new Float32Array(l),c.STREAM_DRAW),c.useProgram(h.program);var v=c.FLOAT,M=!1,p=0,d=0;c.bindBuffer(c.ARRAY_BUFFER,h.glBuffers.xy),c.vertexAttribPointer(h.attribLocations.xy,2,v,M,p,d),c.enableVertexAttribArray(h.attribLocations.xy);v=c.FLOAT,M=!1,p=0,d=0;c.bindBuffer(c.ARRAY_BUFFER,h.glBuffers.color),c.vertexAttribPointer(h.attribLocations.color,4,v,M,p,d),c.enableVertexAttribArray(h.attribLocations.color),c.activeTexture(c.TEXTURE0),c.bindTexture(c.TEXTURE_2D,t.O),c.activeTexture(c.TEXTURE1),c.bindTexture(c.TEXTURE_2D,t.C),c.uniform1i(h.uniformLocations.uSamplerPalettes,0),c.uniform1i(h.uniformLocations.uSamplerOthers,1),c.uniform4f(h.uniformLocations.colorSwaps,m.l[0],m.l[1],m.l[2],m.l[3]),c.uniformMatrix4fv(h.uniformLocations.projectionMatrix,!1,t.T),c.uniformMatrix3fv(h.uniformLocations.modelViewMatrix,!1,t.P);d=0;c.drawArrays(c.TRIANGLE_STRIP,d,4)}var E=function(){function t(t,n,r,e,i,o){this.x=t,this.y=n,this.w=r,this.h=e,this.designTileset=i,this.designPalette=o}return t.prototype.offset=function(t,n,r,e){return this.x+=t,this.y+=n,this.w=r,this.h=e,this},t}(),A=function(){function t(t,n,r){this.y=t,this.w=n,this.h=r}return t.prototype.offset=function(t,n,r){return this.y+=t,this.w=n,this.h=r,this},t}(),z=function(){function t(t,n,r,e,i,o,a,u,f){this.x=t,this.y=n,this.w=r,this.h=e,this.tw=i,this.th=o,this.tiles=a,this.hiColor=u,this.designPalette=f}return t.prototype.offset=function(t,n,r,e){return this.x+=t,this.y+=n,this.w=r,this.h=e,this},t.prototype.tile=function(t){t=Math.floor(t);var n=Math.floor(this.w/this.tw);if(this.w/this.tw!==n)throw new Error("Not a tileset (w="+this.w+", h="+this.h+", tw="+this.tw+")");var r=t%n,e=Math.floor(t/n);return this.offset(r*this.tw,e*this.th,this.tw,this.th)},t}(),j=function(){function t(t,n,r){this.array=t,this.width=n,this.height=r}return t.prototype.getElement=function(t,n){return this.array[this.width*Math.floor(n)+Math.floor(t)]},t.prototype.setElement=function(t,n,r){this.array[this.width*Math.floor(n)+Math.floor(t)]=r},t}(),D=r(1),B=function(){function t(t,n,r,e){this.posterizeToBpp=-1,this.buffer=t,this.width=n,this.height=r,this.pixelsPerTexel=e}return t.prototype.clone=function(){var n=new t(this.buffer.slice(0),this.width,this.height,this.pixelsPerTexel);return n.posterizeToBpp=this.posterizeToBpp,n},t.prototype.readToBuffer=function(t,n,r,e,i){if(typeof this.buffer!=typeof i)throw new Error("readFromShadowTexture: dest buffer must be of same type");for(var o=this.width*this.pixelsPerTexel,a=t+n*o,u=0,f=0;f<e;f++)i.set(this.buffer.subarray(a,a+r),u),a+=o,u+=r},t.prototype.setPosterization=function(t){if(this.buffer.constructor!==Uint32Array)throw new Error("Posterization only available for color buffers (32-bit)");this.posterizeToBpp=t},t.prototype.writeTo=function(t,n,r,e,i){if(typeof this.buffer!=typeof i)throw new Error("writeToShadowTexture: data must be of same type");for(var o=this.width*this.pixelsPerTexel,a=0,u=t+n*o,f=0;f<e;f++)this.buffer.set(i.subarray(a,a+r),u),a+=r,u+=o},t.prototype.syncToVramTexture=function(n,r,e,i,o,a){o=Math.ceil(o/this.pixelsPerTexel),e%this.pixelsPerTexel>0&&(o+=1),e=Math.floor(e/this.pixelsPerTexel);var u=new Uint32Array(o*a);if(new t(new Uint32Array(this.buffer.buffer),this.width,this.height,1).readToBuffer(e,i,o,a,u),this.posterizeToBpp>=1)for(var f=0;f<u.length;f++)u[f]=D.a.posterize(u[f],this.posterizeToBpp);n.bindTexture(n.TEXTURE_2D,r),n.texSubImage2D(n.TEXTURE_2D,0,e,i,o,a,n.RGBA,n.UNSIGNED_BYTE,new Uint8Array(u.buffer))},t}();var F=1e-6,L="undefined"!=typeof Float32Array?Float32Array:Array,U=Math.random;Math.PI;function k(){var t=new L(9);return L!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1,t}function N(t,n){return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[4],t[4]=n[5],t[5]=n[6],t[6]=n[8],t[7]=n[9],t[8]=n[10],t}function V(t){var n=new L(9);return n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[4]=t[4],n[5]=t[5],n[6]=t[6],n[7]=t[7],n[8]=t[8],n}function q(t,n){return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],t}function R(t,n,r,e,i,o,a,u,f){var c=new L(9);return c[0]=t,c[1]=n,c[2]=r,c[3]=e,c[4]=i,c[5]=o,c[6]=a,c[7]=u,c[8]=f,c}function W(t,n,r,e,i,o,a,u,f,c){return t[0]=n,t[1]=r,t[2]=e,t[3]=i,t[4]=o,t[5]=a,t[6]=u,t[7]=f,t[8]=c,t}function X(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function G(t,n){if(t===n){var r=n[1],e=n[2],i=n[5];t[1]=n[3],t[2]=n[6],t[3]=r,t[5]=n[7],t[6]=e,t[7]=i}else t[0]=n[0],t[1]=n[3],t[2]=n[6],t[3]=n[1],t[4]=n[4],t[5]=n[7],t[6]=n[2],t[7]=n[5],t[8]=n[8];return t}function K(t,n){var r=n[0],e=n[1],i=n[2],o=n[3],a=n[4],u=n[5],f=n[6],c=n[7],h=n[8],s=h*a-u*c,l=-h*o+u*f,v=c*o-a*f,M=r*s+e*l+i*v;return M?(M=1/M,t[0]=s*M,t[1]=(-h*e+i*c)*M,t[2]=(u*e-i*a)*M,t[3]=l*M,t[4]=(h*r-i*f)*M,t[5]=(-u*r+i*o)*M,t[6]=v*M,t[7]=(-c*r+e*f)*M,t[8]=(a*r-e*o)*M,t):null}function Y(t,n){var r=n[0],e=n[1],i=n[2],o=n[3],a=n[4],u=n[5],f=n[6],c=n[7],h=n[8];return t[0]=a*h-u*c,t[1]=i*c-e*h,t[2]=e*u-i*a,t[3]=u*f-o*h,t[4]=r*h-i*f,t[5]=i*o-r*u,t[6]=o*c-a*f,t[7]=e*f-r*c,t[8]=r*a-e*o,t}function H(t){var n=t[0],r=t[1],e=t[2],i=t[3],o=t[4],a=t[5],u=t[6],f=t[7],c=t[8];return n*(c*o-a*f)+r*(-c*i+a*u)+e*(f*i-o*u)}function J(t,n,r){var e=n[0],i=n[1],o=n[2],a=n[3],u=n[4],f=n[5],c=n[6],h=n[7],s=n[8],l=r[0],v=r[1],M=r[2],p=r[3],d=r[4],m=r[5],x=r[6],w=r[7],y=r[8];return t[0]=l*e+v*a+M*c,t[1]=l*i+v*u+M*h,t[2]=l*o+v*f+M*s,t[3]=p*e+d*a+m*c,t[4]=p*i+d*u+m*h,t[5]=p*o+d*f+m*s,t[6]=x*e+w*a+y*c,t[7]=x*i+w*u+y*h,t[8]=x*o+w*f+y*s,t}function Q(t,n,r){var e=n[0],i=n[1],o=n[2],a=n[3],u=n[4],f=n[5],c=n[6],h=n[7],s=n[8],l=r[0],v=r[1];return t[0]=e,t[1]=i,t[2]=o,t[3]=a,t[4]=u,t[5]=f,t[6]=l*e+v*a+c,t[7]=l*i+v*u+h,t[8]=l*o+v*f+s,t}function Z(t,n,r){var e=n[0],i=n[1],o=n[2],a=n[3],u=n[4],f=n[5],c=n[6],h=n[7],s=n[8],l=Math.sin(r),v=Math.cos(r);return t[0]=v*e+l*a,t[1]=v*i+l*u,t[2]=v*o+l*f,t[3]=v*a-l*e,t[4]=v*u-l*i,t[5]=v*f-l*o,t[6]=c,t[7]=h,t[8]=s,t}function $(t,n,r){var e=r[0],i=r[1];return t[0]=e*n[0],t[1]=e*n[1],t[2]=e*n[2],t[3]=i*n[3],t[4]=i*n[4],t[5]=i*n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],t}function tt(t,n){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=n[0],t[7]=n[1],t[8]=1,t}function nt(t,n){var r=Math.sin(n),e=Math.cos(n);return t[0]=e,t[1]=r,t[2]=0,t[3]=-r,t[4]=e,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function rt(t,n){return t[0]=n[0],t[1]=0,t[2]=0,t[3]=0,t[4]=n[1],t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function et(t,n){return t[0]=n[0],t[1]=n[1],t[2]=0,t[3]=n[2],t[4]=n[3],t[5]=0,t[6]=n[4],t[7]=n[5],t[8]=1,t}function it(t,n){var r=n[0],e=n[1],i=n[2],o=n[3],a=r+r,u=e+e,f=i+i,c=r*a,h=e*a,s=e*u,l=i*a,v=i*u,M=i*f,p=o*a,d=o*u,m=o*f;return t[0]=1-s-M,t[3]=h-m,t[6]=l+d,t[1]=h+m,t[4]=1-c-M,t[7]=v-p,t[2]=l-d,t[5]=v+p,t[8]=1-c-s,t}function ot(t,n){var r=n[0],e=n[1],i=n[2],o=n[3],a=n[4],u=n[5],f=n[6],c=n[7],h=n[8],s=n[9],l=n[10],v=n[11],M=n[12],p=n[13],d=n[14],m=n[15],x=r*u-e*a,w=r*f-i*a,y=r*c-o*a,_=e*f-i*u,b=e*c-o*u,g=i*c-o*f,S=h*p-s*M,O=h*d-l*M,C=h*m-v*M,T=s*d-l*p,P=s*m-v*p,I=l*m-v*d,E=x*I-w*P+y*T+_*C-b*O+g*S;return E?(E=1/E,t[0]=(u*I-f*P+c*T)*E,t[1]=(f*C-a*I-c*O)*E,t[2]=(a*P-u*C+c*S)*E,t[3]=(i*P-e*I-o*T)*E,t[4]=(r*I-i*C+o*O)*E,t[5]=(e*C-r*P-o*S)*E,t[6]=(p*g-d*b+m*_)*E,t[7]=(d*y-M*g-m*w)*E,t[8]=(M*b-p*y+m*x)*E,t):null}function at(t,n,r){return t[0]=2/n,t[1]=0,t[2]=0,t[3]=0,t[4]=-2/r,t[5]=0,t[6]=-1,t[7]=1,t[8]=1,t}function ut(t){return"mat3("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+")"}function ft(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2))}function ct(t,n,r){return t[0]=n[0]+r[0],t[1]=n[1]+r[1],t[2]=n[2]+r[2],t[3]=n[3]+r[3],t[4]=n[4]+r[4],t[5]=n[5]+r[5],t[6]=n[6]+r[6],t[7]=n[7]+r[7],t[8]=n[8]+r[8],t}function ht(t,n,r){return t[0]=n[0]-r[0],t[1]=n[1]-r[1],t[2]=n[2]-r[2],t[3]=n[3]-r[3],t[4]=n[4]-r[4],t[5]=n[5]-r[5],t[6]=n[6]-r[6],t[7]=n[7]-r[7],t[8]=n[8]-r[8],t}function st(t,n,r){return t[0]=n[0]*r,t[1]=n[1]*r,t[2]=n[2]*r,t[3]=n[3]*r,t[4]=n[4]*r,t[5]=n[5]*r,t[6]=n[6]*r,t[7]=n[7]*r,t[8]=n[8]*r,t}function lt(t,n,r,e){return t[0]=n[0]+r[0]*e,t[1]=n[1]+r[1]*e,t[2]=n[2]+r[2]*e,t[3]=n[3]+r[3]*e,t[4]=n[4]+r[4]*e,t[5]=n[5]+r[5]*e,t[6]=n[6]+r[6]*e,t[7]=n[7]+r[7]*e,t[8]=n[8]+r[8]*e,t}function vt(t,n){return t[0]===n[0]&&t[1]===n[1]&&t[2]===n[2]&&t[3]===n[3]&&t[4]===n[4]&&t[5]===n[5]&&t[6]===n[6]&&t[7]===n[7]&&t[8]===n[8]}function Mt(t,n){var r=t[0],e=t[1],i=t[2],o=t[3],a=t[4],u=t[5],f=t[6],c=t[7],h=t[8],s=n[0],l=n[1],v=n[2],M=n[3],p=n[4],d=n[5],m=n[6],x=n[7],w=n[8];return Math.abs(r-s)<=F*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(e-l)<=F*Math.max(1,Math.abs(e),Math.abs(l))&&Math.abs(i-v)<=F*Math.max(1,Math.abs(i),Math.abs(v))&&Math.abs(o-M)<=F*Math.max(1,Math.abs(o),Math.abs(M))&&Math.abs(a-p)<=F*Math.max(1,Math.abs(a),Math.abs(p))&&Math.abs(u-d)<=F*Math.max(1,Math.abs(u),Math.abs(d))&&Math.abs(f-m)<=F*Math.max(1,Math.abs(f),Math.abs(m))&&Math.abs(c-x)<=F*Math.max(1,Math.abs(c),Math.abs(x))&&Math.abs(h-w)<=F*Math.max(1,Math.abs(h),Math.abs(w))}var pt=J,dt=ht;function mt(){var t=new L(16);return L!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function xt(t){var n=new L(16);return n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[4]=t[4],n[5]=t[5],n[6]=t[6],n[7]=t[7],n[8]=t[8],n[9]=t[9],n[10]=t[10],n[11]=t[11],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15],n}function wt(t,n){return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],t[9]=n[9],t[10]=n[10],t[11]=n[11],t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15],t}function yt(t,n,r,e,i,o,a,u,f,c,h,s,l,v,M,p){var d=new L(16);return d[0]=t,d[1]=n,d[2]=r,d[3]=e,d[4]=i,d[5]=o,d[6]=a,d[7]=u,d[8]=f,d[9]=c,d[10]=h,d[11]=s,d[12]=l,d[13]=v,d[14]=M,d[15]=p,d}function _t(t,n,r,e,i,o,a,u,f,c,h,s,l,v,M,p,d){return t[0]=n,t[1]=r,t[2]=e,t[3]=i,t[4]=o,t[5]=a,t[6]=u,t[7]=f,t[8]=c,t[9]=h,t[10]=s,t[11]=l,t[12]=v,t[13]=M,t[14]=p,t[15]=d,t}function bt(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function gt(t,n){if(t===n){var r=n[1],e=n[2],i=n[3],o=n[6],a=n[7],u=n[11];t[1]=n[4],t[2]=n[8],t[3]=n[12],t[4]=r,t[6]=n[9],t[7]=n[13],t[8]=e,t[9]=o,t[11]=n[14],t[12]=i,t[13]=a,t[14]=u}else t[0]=n[0],t[1]=n[4],t[2]=n[8],t[3]=n[12],t[4]=n[1],t[5]=n[5],t[6]=n[9],t[7]=n[13],t[8]=n[2],t[9]=n[6],t[10]=n[10],t[11]=n[14],t[12]=n[3],t[13]=n[7],t[14]=n[11],t[15]=n[15];return t}function St(t,n){var r=n[0],e=n[1],i=n[2],o=n[3],a=n[4],u=n[5],f=n[6],c=n[7],h=n[8],s=n[9],l=n[10],v=n[11],M=n[12],p=n[13],d=n[14],m=n[15],x=r*u-e*a,w=r*f-i*a,y=r*c-o*a,_=e*f-i*u,b=e*c-o*u,g=i*c-o*f,S=h*p-s*M,O=h*d-l*M,C=h*m-v*M,T=s*d-l*p,P=s*m-v*p,I=l*m-v*d,E=x*I-w*P+y*T+_*C-b*O+g*S;return E?(E=1/E,t[0]=(u*I-f*P+c*T)*E,t[1]=(i*P-e*I-o*T)*E,t[2]=(p*g-d*b+m*_)*E,t[3]=(l*b-s*g-v*_)*E,t[4]=(f*C-a*I-c*O)*E,t[5]=(r*I-i*C+o*O)*E,t[6]=(d*y-M*g-m*w)*E,t[7]=(h*g-l*y+v*w)*E,t[8]=(a*P-u*C+c*S)*E,t[9]=(e*C-r*P-o*S)*E,t[10]=(M*b-p*y+m*x)*E,t[11]=(s*y-h*b-v*x)*E,t[12]=(u*O-a*T-f*S)*E,t[13]=(r*T-e*O+i*S)*E,t[14]=(p*w-M*_-d*x)*E,t[15]=(h*_-s*w+l*x)*E,t):null}function Ot(t,n){var r=n[0],e=n[1],i=n[2],o=n[3],a=n[4],u=n[5],f=n[6],c=n[7],h=n[8],s=n[9],l=n[10],v=n[11],M=n[12],p=n[13],d=n[14],m=n[15];return t[0]=u*(l*m-v*d)-s*(f*m-c*d)+p*(f*v-c*l),t[1]=-(e*(l*m-v*d)-s*(i*m-o*d)+p*(i*v-o*l)),t[2]=e*(f*m-c*d)-u*(i*m-o*d)+p*(i*c-o*f),t[3]=-(e*(f*v-c*l)-u*(i*v-o*l)+s*(i*c-o*f)),t[4]=-(a*(l*m-v*d)-h*(f*m-c*d)+M*(f*v-c*l)),t[5]=r*(l*m-v*d)-h*(i*m-o*d)+M*(i*v-o*l),t[6]=-(r*(f*m-c*d)-a*(i*m-o*d)+M*(i*c-o*f)),t[7]=r*(f*v-c*l)-a*(i*v-o*l)+h*(i*c-o*f),t[8]=a*(s*m-v*p)-h*(u*m-c*p)+M*(u*v-c*s),t[9]=-(r*(s*m-v*p)-h*(e*m-o*p)+M*(e*v-o*s)),t[10]=r*(u*m-c*p)-a*(e*m-o*p)+M*(e*c-o*u),t[11]=-(r*(u*v-c*s)-a*(e*v-o*s)+h*(e*c-o*u)),t[12]=-(a*(s*d-l*p)-h*(u*d-f*p)+M*(u*l-f*s)),t[13]=r*(s*d-l*p)-h*(e*d-i*p)+M*(e*l-i*s),t[14]=-(r*(u*d-f*p)-a*(e*d-i*p)+M*(e*f-i*u)),t[15]=r*(u*l-f*s)-a*(e*l-i*s)+h*(e*f-i*u),t}function Ct(t){var n=t[0],r=t[1],e=t[2],i=t[3],o=t[4],a=t[5],u=t[6],f=t[7],c=t[8],h=t[9],s=t[10],l=t[11],v=t[12],M=t[13],p=t[14],d=t[15];return(n*a-r*o)*(s*d-l*p)-(n*u-e*o)*(h*d-l*M)+(n*f-i*o)*(h*p-s*M)+(r*u-e*a)*(c*d-l*v)-(r*f-i*a)*(c*p-s*v)+(e*f-i*u)*(c*M-h*v)}function Tt(t,n,r){var e=n[0],i=n[1],o=n[2],a=n[3],u=n[4],f=n[5],c=n[6],h=n[7],s=n[8],l=n[9],v=n[10],M=n[11],p=n[12],d=n[13],m=n[14],x=n[15],w=r[0],y=r[1],_=r[2],b=r[3];return t[0]=w*e+y*u+_*s+b*p,t[1]=w*i+y*f+_*l+b*d,t[2]=w*o+y*c+_*v+b*m,t[3]=w*a+y*h+_*M+b*x,w=r[4],y=r[5],_=r[6],b=r[7],t[4]=w*e+y*u+_*s+b*p,t[5]=w*i+y*f+_*l+b*d,t[6]=w*o+y*c+_*v+b*m,t[7]=w*a+y*h+_*M+b*x,w=r[8],y=r[9],_=r[10],b=r[11],t[8]=w*e+y*u+_*s+b*p,t[9]=w*i+y*f+_*l+b*d,t[10]=w*o+y*c+_*v+b*m,t[11]=w*a+y*h+_*M+b*x,w=r[12],y=r[13],_=r[14],b=r[15],t[12]=w*e+y*u+_*s+b*p,t[13]=w*i+y*f+_*l+b*d,t[14]=w*o+y*c+_*v+b*m,t[15]=w*a+y*h+_*M+b*x,t}function Pt(t,n,r){var e,i,o,a,u,f,c,h,s,l,v,M,p=r[0],d=r[1],m=r[2];return n===t?(t[12]=n[0]*p+n[4]*d+n[8]*m+n[12],t[13]=n[1]*p+n[5]*d+n[9]*m+n[13],t[14]=n[2]*p+n[6]*d+n[10]*m+n[14],t[15]=n[3]*p+n[7]*d+n[11]*m+n[15]):(e=n[0],i=n[1],o=n[2],a=n[3],u=n[4],f=n[5],c=n[6],h=n[7],s=n[8],l=n[9],v=n[10],M=n[11],t[0]=e,t[1]=i,t[2]=o,t[3]=a,t[4]=u,t[5]=f,t[6]=c,t[7]=h,t[8]=s,t[9]=l,t[10]=v,t[11]=M,t[12]=e*p+u*d+s*m+n[12],t[13]=i*p+f*d+l*m+n[13],t[14]=o*p+c*d+v*m+n[14],t[15]=a*p+h*d+M*m+n[15]),t}function It(t,n,r){var e=r[0],i=r[1],o=r[2];return t[0]=n[0]*e,t[1]=n[1]*e,t[2]=n[2]*e,t[3]=n[3]*e,t[4]=n[4]*i,t[5]=n[5]*i,t[6]=n[6]*i,t[7]=n[7]*i,t[8]=n[8]*o,t[9]=n[9]*o,t[10]=n[10]*o,t[11]=n[11]*o,t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15],t}function Et(t,n,r,e){var i,o,a,u,f,c,h,s,l,v,M,p,d,m,x,w,y,_,b,g,S,O,C,T,P=e[0],I=e[1],E=e[2],A=Math.sqrt(P*P+I*I+E*E);return A<F?null:(P*=A=1/A,I*=A,E*=A,i=Math.sin(r),a=1-(o=Math.cos(r)),u=n[0],f=n[1],c=n[2],h=n[3],s=n[4],l=n[5],v=n[6],M=n[7],p=n[8],d=n[9],m=n[10],x=n[11],w=P*P*a+o,y=I*P*a+E*i,_=E*P*a-I*i,b=P*I*a-E*i,g=I*I*a+o,S=E*I*a+P*i,O=P*E*a+I*i,C=I*E*a-P*i,T=E*E*a+o,t[0]=u*w+s*y+p*_,t[1]=f*w+l*y+d*_,t[2]=c*w+v*y+m*_,t[3]=h*w+M*y+x*_,t[4]=u*b+s*g+p*S,t[5]=f*b+l*g+d*S,t[6]=c*b+v*g+m*S,t[7]=h*b+M*g+x*S,t[8]=u*O+s*C+p*T,t[9]=f*O+l*C+d*T,t[10]=c*O+v*C+m*T,t[11]=h*O+M*C+x*T,n!==t&&(t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15]),t)}function At(t,n,r){var e=Math.sin(r),i=Math.cos(r),o=n[4],a=n[5],u=n[6],f=n[7],c=n[8],h=n[9],s=n[10],l=n[11];return n!==t&&(t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15]),t[4]=o*i+c*e,t[5]=a*i+h*e,t[6]=u*i+s*e,t[7]=f*i+l*e,t[8]=c*i-o*e,t[9]=h*i-a*e,t[10]=s*i-u*e,t[11]=l*i-f*e,t}function zt(t,n,r){var e=Math.sin(r),i=Math.cos(r),o=n[0],a=n[1],u=n[2],f=n[3],c=n[8],h=n[9],s=n[10],l=n[11];return n!==t&&(t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15]),t[0]=o*i-c*e,t[1]=a*i-h*e,t[2]=u*i-s*e,t[3]=f*i-l*e,t[8]=o*e+c*i,t[9]=a*e+h*i,t[10]=u*e+s*i,t[11]=f*e+l*i,t}function jt(t,n,r){var e=Math.sin(r),i=Math.cos(r),o=n[0],a=n[1],u=n[2],f=n[3],c=n[4],h=n[5],s=n[6],l=n[7];return n!==t&&(t[8]=n[8],t[9]=n[9],t[10]=n[10],t[11]=n[11],t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15]),t[0]=o*i+c*e,t[1]=a*i+h*e,t[2]=u*i+s*e,t[3]=f*i+l*e,t[4]=c*i-o*e,t[5]=h*i-a*e,t[6]=s*i-u*e,t[7]=l*i-f*e,t}function Dt(t,n){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=1,t}function Bt(t,n){return t[0]=n[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=n[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=n[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Ft(t,n,r){var e,i,o,a=r[0],u=r[1],f=r[2],c=Math.sqrt(a*a+u*u+f*f);return c<F?null:(a*=c=1/c,u*=c,f*=c,e=Math.sin(n),o=1-(i=Math.cos(n)),t[0]=a*a*o+i,t[1]=u*a*o+f*e,t[2]=f*a*o-u*e,t[3]=0,t[4]=a*u*o-f*e,t[5]=u*u*o+i,t[6]=f*u*o+a*e,t[7]=0,t[8]=a*f*o+u*e,t[9]=u*f*o-a*e,t[10]=f*f*o+i,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t)}function Lt(t,n){var r=Math.sin(n),e=Math.cos(n);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e,t[6]=r,t[7]=0,t[8]=0,t[9]=-r,t[10]=e,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Ut(t,n){var r=Math.sin(n),e=Math.cos(n);return t[0]=e,t[1]=0,t[2]=-r,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=r,t[9]=0,t[10]=e,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function kt(t,n){var r=Math.sin(n),e=Math.cos(n);return t[0]=e,t[1]=r,t[2]=0,t[3]=0,t[4]=-r,t[5]=e,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Nt(t,n,r){var e=n[0],i=n[1],o=n[2],a=n[3],u=e+e,f=i+i,c=o+o,h=e*u,s=e*f,l=e*c,v=i*f,M=i*c,p=o*c,d=a*u,m=a*f,x=a*c;return t[0]=1-(v+p),t[1]=s+x,t[2]=l-m,t[3]=0,t[4]=s-x,t[5]=1-(h+p),t[6]=M+d,t[7]=0,t[8]=l+m,t[9]=M-d,t[10]=1-(h+v),t[11]=0,t[12]=r[0],t[13]=r[1],t[14]=r[2],t[15]=1,t}function Vt(t,n){var r=new L(3),e=-n[0],i=-n[1],o=-n[2],a=n[3],u=n[4],f=n[5],c=n[6],h=n[7],s=e*e+i*i+o*o+a*a;return s>0?(r[0]=2*(u*a+h*e+f*o-c*i)/s,r[1]=2*(f*a+h*i+c*e-u*o)/s,r[2]=2*(c*a+h*o+u*i-f*e)/s):(r[0]=2*(u*a+h*e+f*o-c*i),r[1]=2*(f*a+h*i+c*e-u*o),r[2]=2*(c*a+h*o+u*i-f*e)),Nt(t,n,r),t}function qt(t,n){return t[0]=n[12],t[1]=n[13],t[2]=n[14],t}function Rt(t,n){var r=n[0],e=n[1],i=n[2],o=n[4],a=n[5],u=n[6],f=n[8],c=n[9],h=n[10];return t[0]=Math.sqrt(r*r+e*e+i*i),t[1]=Math.sqrt(o*o+a*a+u*u),t[2]=Math.sqrt(f*f+c*c+h*h),t}function Wt(t,n){var r=n[0]+n[5]+n[10],e=0;return r>0?(e=2*Math.sqrt(r+1),t[3]=.25*e,t[0]=(n[6]-n[9])/e,t[1]=(n[8]-n[2])/e,t[2]=(n[1]-n[4])/e):n[0]>n[5]&&n[0]>n[10]?(e=2*Math.sqrt(1+n[0]-n[5]-n[10]),t[3]=(n[6]-n[9])/e,t[0]=.25*e,t[1]=(n[1]+n[4])/e,t[2]=(n[8]+n[2])/e):n[5]>n[10]?(e=2*Math.sqrt(1+n[5]-n[0]-n[10]),t[3]=(n[8]-n[2])/e,t[0]=(n[1]+n[4])/e,t[1]=.25*e,t[2]=(n[6]+n[9])/e):(e=2*Math.sqrt(1+n[10]-n[0]-n[5]),t[3]=(n[1]-n[4])/e,t[0]=(n[8]+n[2])/e,t[1]=(n[6]+n[9])/e,t[2]=.25*e),t}function Xt(t,n,r,e){var i=n[0],o=n[1],a=n[2],u=n[3],f=i+i,c=o+o,h=a+a,s=i*f,l=i*c,v=i*h,M=o*c,p=o*h,d=a*h,m=u*f,x=u*c,w=u*h,y=e[0],_=e[1],b=e[2];return t[0]=(1-(M+d))*y,t[1]=(l+w)*y,t[2]=(v-x)*y,t[3]=0,t[4]=(l-w)*_,t[5]=(1-(s+d))*_,t[6]=(p+m)*_,t[7]=0,t[8]=(v+x)*b,t[9]=(p-m)*b,t[10]=(1-(s+M))*b,t[11]=0,t[12]=r[0],t[13]=r[1],t[14]=r[2],t[15]=1,t}function Gt(t,n,r,e,i){var o=n[0],a=n[1],u=n[2],f=n[3],c=o+o,h=a+a,s=u+u,l=o*c,v=o*h,M=o*s,p=a*h,d=a*s,m=u*s,x=f*c,w=f*h,y=f*s,_=e[0],b=e[1],g=e[2],S=i[0],O=i[1],C=i[2],T=(1-(p+m))*_,P=(v+y)*_,I=(M-w)*_,E=(v-y)*b,A=(1-(l+m))*b,z=(d+x)*b,j=(M+w)*g,D=(d-x)*g,B=(1-(l+p))*g;return t[0]=T,t[1]=P,t[2]=I,t[3]=0,t[4]=E,t[5]=A,t[6]=z,t[7]=0,t[8]=j,t[9]=D,t[10]=B,t[11]=0,t[12]=r[0]+S-(T*S+E*O+j*C),t[13]=r[1]+O-(P*S+A*O+D*C),t[14]=r[2]+C-(I*S+z*O+B*C),t[15]=1,t}function Kt(t,n){var r=n[0],e=n[1],i=n[2],o=n[3],a=r+r,u=e+e,f=i+i,c=r*a,h=e*a,s=e*u,l=i*a,v=i*u,M=i*f,p=o*a,d=o*u,m=o*f;return t[0]=1-s-M,t[1]=h+m,t[2]=l-d,t[3]=0,t[4]=h-m,t[5]=1-c-M,t[6]=v+p,t[7]=0,t[8]=l+d,t[9]=v-p,t[10]=1-c-s,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Yt(t,n,r,e,i,o,a){var u=1/(r-n),f=1/(i-e),c=1/(o-a);return t[0]=2*o*u,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*o*f,t[6]=0,t[7]=0,t[8]=(r+n)*u,t[9]=(i+e)*f,t[10]=(a+o)*c,t[11]=-1,t[12]=0,t[13]=0,t[14]=a*o*2*c,t[15]=0,t}function Ht(t,n,r,e,i){var o,a=1/Math.tan(n/2);return t[0]=a/r,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=a,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=i&&i!==1/0?(o=1/(e-i),t[10]=(i+e)*o,t[14]=2*i*e*o):(t[10]=-1,t[14]=-2*e),t}function Jt(t,n,r,e){var i=Math.tan(n.upDegrees*Math.PI/180),o=Math.tan(n.downDegrees*Math.PI/180),a=Math.tan(n.leftDegrees*Math.PI/180),u=Math.tan(n.rightDegrees*Math.PI/180),f=2/(a+u),c=2/(i+o);return t[0]=f,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=c,t[6]=0,t[7]=0,t[8]=-(a-u)*f*.5,t[9]=(i-o)*c*.5,t[10]=e/(r-e),t[11]=-1,t[12]=0,t[13]=0,t[14]=e*r/(r-e),t[15]=0,t}function Qt(t,n,r,e,i,o,a){var u=1/(n-r),f=1/(e-i),c=1/(o-a);return t[0]=-2*u,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*f,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*c,t[11]=0,t[12]=(n+r)*u,t[13]=(i+e)*f,t[14]=(a+o)*c,t[15]=1,t}function Zt(t,n,r,e){var i,o,a,u,f,c,h,s,l,v,M=n[0],p=n[1],d=n[2],m=e[0],x=e[1],w=e[2],y=r[0],_=r[1],b=r[2];return Math.abs(M-y)<F&&Math.abs(p-_)<F&&Math.abs(d-b)<F?bt(t):(h=M-y,s=p-_,l=d-b,i=x*(l*=v=1/Math.sqrt(h*h+s*s+l*l))-w*(s*=v),o=w*(h*=v)-m*l,a=m*s-x*h,(v=Math.sqrt(i*i+o*o+a*a))?(i*=v=1/v,o*=v,a*=v):(i=0,o=0,a=0),u=s*a-l*o,f=l*i-h*a,c=h*o-s*i,(v=Math.sqrt(u*u+f*f+c*c))?(u*=v=1/v,f*=v,c*=v):(u=0,f=0,c=0),t[0]=i,t[1]=u,t[2]=h,t[3]=0,t[4]=o,t[5]=f,t[6]=s,t[7]=0,t[8]=a,t[9]=c,t[10]=l,t[11]=0,t[12]=-(i*M+o*p+a*d),t[13]=-(u*M+f*p+c*d),t[14]=-(h*M+s*p+l*d),t[15]=1,t)}function $t(t,n,r,e){var i=n[0],o=n[1],a=n[2],u=e[0],f=e[1],c=e[2],h=i-r[0],s=o-r[1],l=a-r[2],v=h*h+s*s+l*l;v>0&&(h*=v=1/Math.sqrt(v),s*=v,l*=v);var M=f*l-c*s,p=c*h-u*l,d=u*s-f*h;return(v=M*M+p*p+d*d)>0&&(M*=v=1/Math.sqrt(v),p*=v,d*=v),t[0]=M,t[1]=p,t[2]=d,t[3]=0,t[4]=s*d-l*p,t[5]=l*M-h*d,t[6]=h*p-s*M,t[7]=0,t[8]=h,t[9]=s,t[10]=l,t[11]=0,t[12]=i,t[13]=o,t[14]=a,t[15]=1,t}function tn(t){return"mat4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+")"}function nn(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2)+Math.pow(t[9],2)+Math.pow(t[10],2)+Math.pow(t[11],2)+Math.pow(t[12],2)+Math.pow(t[13],2)+Math.pow(t[14],2)+Math.pow(t[15],2))}function rn(t,n,r){return t[0]=n[0]+r[0],t[1]=n[1]+r[1],t[2]=n[2]+r[2],t[3]=n[3]+r[3],t[4]=n[4]+r[4],t[5]=n[5]+r[5],t[6]=n[6]+r[6],t[7]=n[7]+r[7],t[8]=n[8]+r[8],t[9]=n[9]+r[9],t[10]=n[10]+r[10],t[11]=n[11]+r[11],t[12]=n[12]+r[12],t[13]=n[13]+r[13],t[14]=n[14]+r[14],t[15]=n[15]+r[15],t}function en(t,n,r){return t[0]=n[0]-r[0],t[1]=n[1]-r[1],t[2]=n[2]-r[2],t[3]=n[3]-r[3],t[4]=n[4]-r[4],t[5]=n[5]-r[5],t[6]=n[6]-r[6],t[7]=n[7]-r[7],t[8]=n[8]-r[8],t[9]=n[9]-r[9],t[10]=n[10]-r[10],t[11]=n[11]-r[11],t[12]=n[12]-r[12],t[13]=n[13]-r[13],t[14]=n[14]-r[14],t[15]=n[15]-r[15],t}function on(t,n,r){return t[0]=n[0]*r,t[1]=n[1]*r,t[2]=n[2]*r,t[3]=n[3]*r,t[4]=n[4]*r,t[5]=n[5]*r,t[6]=n[6]*r,t[7]=n[7]*r,t[8]=n[8]*r,t[9]=n[9]*r,t[10]=n[10]*r,t[11]=n[11]*r,t[12]=n[12]*r,t[13]=n[13]*r,t[14]=n[14]*r,t[15]=n[15]*r,t}function an(t,n,r,e){return t[0]=n[0]+r[0]*e,t[1]=n[1]+r[1]*e,t[2]=n[2]+r[2]*e,t[3]=n[3]+r[3]*e,t[4]=n[4]+r[4]*e,t[5]=n[5]+r[5]*e,t[6]=n[6]+r[6]*e,t[7]=n[7]+r[7]*e,t[8]=n[8]+r[8]*e,t[9]=n[9]+r[9]*e,t[10]=n[10]+r[10]*e,t[11]=n[11]+r[11]*e,t[12]=n[12]+r[12]*e,t[13]=n[13]+r[13]*e,t[14]=n[14]+r[14]*e,t[15]=n[15]+r[15]*e,t}function un(t,n){return t[0]===n[0]&&t[1]===n[1]&&t[2]===n[2]&&t[3]===n[3]&&t[4]===n[4]&&t[5]===n[5]&&t[6]===n[6]&&t[7]===n[7]&&t[8]===n[8]&&t[9]===n[9]&&t[10]===n[10]&&t[11]===n[11]&&t[12]===n[12]&&t[13]===n[13]&&t[14]===n[14]&&t[15]===n[15]}function fn(t,n){var r=t[0],e=t[1],i=t[2],o=t[3],a=t[4],u=t[5],f=t[6],c=t[7],h=t[8],s=t[9],l=t[10],v=t[11],M=t[12],p=t[13],d=t[14],m=t[15],x=n[0],w=n[1],y=n[2],_=n[3],b=n[4],g=n[5],S=n[6],O=n[7],C=n[8],T=n[9],P=n[10],I=n[11],E=n[12],A=n[13],z=n[14],j=n[15];return Math.abs(r-x)<=F*Math.max(1,Math.abs(r),Math.abs(x))&&Math.abs(e-w)<=F*Math.max(1,Math.abs(e),Math.abs(w))&&Math.abs(i-y)<=F*Math.max(1,Math.abs(i),Math.abs(y))&&Math.abs(o-_)<=F*Math.max(1,Math.abs(o),Math.abs(_))&&Math.abs(a-b)<=F*Math.max(1,Math.abs(a),Math.abs(b))&&Math.abs(u-g)<=F*Math.max(1,Math.abs(u),Math.abs(g))&&Math.abs(f-S)<=F*Math.max(1,Math.abs(f),Math.abs(S))&&Math.abs(c-O)<=F*Math.max(1,Math.abs(c),Math.abs(O))&&Math.abs(h-C)<=F*Math.max(1,Math.abs(h),Math.abs(C))&&Math.abs(s-T)<=F*Math.max(1,Math.abs(s),Math.abs(T))&&Math.abs(l-P)<=F*Math.max(1,Math.abs(l),Math.abs(P))&&Math.abs(v-I)<=F*Math.max(1,Math.abs(v),Math.abs(I))&&Math.abs(M-E)<=F*Math.max(1,Math.abs(M),Math.abs(E))&&Math.abs(p-A)<=F*Math.max(1,Math.abs(p),Math.abs(A))&&Math.abs(d-z)<=F*Math.max(1,Math.abs(d),Math.abs(z))&&Math.abs(m-j)<=F*Math.max(1,Math.abs(m),Math.abs(j))}var cn=Tt,hn=en;function sn(){var t=new L(2);return L!=Float32Array&&(t[0]=0,t[1]=0),t}function ln(t){var n=new L(2);return n[0]=t[0],n[1]=t[1],n}function vn(t,n){var r=new L(2);return r[0]=t,r[1]=n,r}function Mn(t,n){return t[0]=n[0],t[1]=n[1],t}function pn(t,n,r){return t[0]=n,t[1]=r,t}function dn(t,n,r){return t[0]=n[0]+r[0],t[1]=n[1]+r[1],t}function mn(t,n,r){return t[0]=n[0]-r[0],t[1]=n[1]-r[1],t}function xn(t,n,r){return t[0]=n[0]*r[0],t[1]=n[1]*r[1],t}function wn(t,n,r){return t[0]=n[0]/r[0],t[1]=n[1]/r[1],t}function yn(t,n){return t[0]=Math.ceil(n[0]),t[1]=Math.ceil(n[1]),t}function _n(t,n){return t[0]=Math.floor(n[0]),t[1]=Math.floor(n[1]),t}function bn(t,n,r){return t[0]=Math.min(n[0],r[0]),t[1]=Math.min(n[1],r[1]),t}function gn(t,n,r){return t[0]=Math.max(n[0],r[0]),t[1]=Math.max(n[1],r[1]),t}function Sn(t,n){return t[0]=Math.round(n[0]),t[1]=Math.round(n[1]),t}function On(t,n,r){return t[0]=n[0]*r,t[1]=n[1]*r,t}function Cn(t,n,r,e){return t[0]=n[0]+r[0]*e,t[1]=n[1]+r[1]*e,t}function Tn(t,n){var r=n[0]-t[0],e=n[1]-t[1];return Math.sqrt(r*r+e*e)}function Pn(t,n){var r=n[0]-t[0],e=n[1]-t[1];return r*r+e*e}function In(t){var n=t[0],r=t[1];return Math.sqrt(n*n+r*r)}function En(t){var n=t[0],r=t[1];return n*n+r*r}function An(t,n){return t[0]=-n[0],t[1]=-n[1],t}function zn(t,n){return t[0]=1/n[0],t[1]=1/n[1],t}function jn(t,n){var r=n[0],e=n[1],i=r*r+e*e;return i>0&&(i=1/Math.sqrt(i)),t[0]=n[0]*i,t[1]=n[1]*i,t}function Dn(t,n){return t[0]*n[0]+t[1]*n[1]}function Bn(t,n,r){var e=n[0]*r[1]-n[1]*r[0];return t[0]=t[1]=0,t[2]=e,t}function Fn(t,n,r,e){var i=n[0],o=n[1];return t[0]=i+e*(r[0]-i),t[1]=o+e*(r[1]-o),t}function Ln(t,n){n=n||1;var r=2*U()*Math.PI;return t[0]=Math.cos(r)*n,t[1]=Math.sin(r)*n,t}function Un(t,n,r){var e=n[0],i=n[1];return t[0]=r[0]*e+r[2]*i,t[1]=r[1]*e+r[3]*i,t}function kn(t,n,r){var e=n[0],i=n[1];return t[0]=r[0]*e+r[2]*i+r[4],t[1]=r[1]*e+r[3]*i+r[5],t}function Nn(t,n,r){var e=n[0],i=n[1];return t[0]=r[0]*e+r[3]*i+r[6],t[1]=r[1]*e+r[4]*i+r[7],t}function Vn(t,n,r){var e=n[0],i=n[1];return t[0]=r[0]*e+r[4]*i+r[12],t[1]=r[1]*e+r[5]*i+r[13],t}function qn(t,n,r,e){var i=n[0]-r[0],o=n[1]-r[1],a=Math.sin(e),u=Math.cos(e);return t[0]=i*u-o*a+r[0],t[1]=i*a+o*u+r[1],t}function Rn(t,n){var r=t[0],e=t[1],i=n[0],o=n[1],a=r*r+e*e;a>0&&(a=1/Math.sqrt(a));var u=i*i+o*o;u>0&&(u=1/Math.sqrt(u));var f=(r*i+e*o)*a*u;return f>1?0:f<-1?Math.PI:Math.acos(f)}function Wn(t){return t[0]=0,t[1]=0,t}function Xn(t){return"vec2("+t[0]+", "+t[1]+")"}function Gn(t,n){return t[0]===n[0]&&t[1]===n[1]}function Kn(t,n){var r=t[0],e=t[1],i=n[0],o=n[1];return Math.abs(r-i)<=F*Math.max(1,Math.abs(r),Math.abs(i))&&Math.abs(e-o)<=F*Math.max(1,Math.abs(e),Math.abs(o))}var Yn,Hn=In,Jn=mn,Qn=xn,Zn=wn,$n=Tn,tr=Pn,nr=En,rr=(Yn=sn(),function(t,n,r,e,i,o){var a,u;for(n||(n=2),r||(r=0),u=e?Math.min(e*n+r,t.length):t.length,a=r;a<u;a+=n)Yn[0]=t[a],Yn[1]=t[a+1],i(Yn,Yn,o),t[a]=Yn[0],t[a+1]=Yn[1];return t});r.d(n,"a",function(){return fr}),r.d(n,"b",function(){return sr}),r.d(n,"c",function(){return xr});var er,ir,or,ar,ur,fr=!0,cr=32,hr=512,sr=16,lr=function(){return function(t,n,r,e){this.effect=t,this.operation=n,this.blendSrc=r,this.blendDst=e}}(),vr=new lr("none","add",0,0),Mr=new lr("blend","add",0,0);function pr(t){return e.fromValues(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],1)}!function(t){t[t.current=0]="current",t[t.rom=1]="rom",t[t.blank=2]="blank"}(ur||(ur={}));var dr=function(){function t(){this.U=-1,this.length=m.h,this.buffer=new Float32Array(8*this.length),this.resetAll()}return t.prototype.getLine=function(t){return this.N(t)},t.prototype.identityAll=function(){this.U=-1;for(var t=0;t<this.length;t++)this.identityLine(t)},t.prototype.identityLine=function(t){var n=e.create();e.identity(n),this.setLine(t,n)},t.prototype.resetAll=function(){this.U=-1;for(var t=0;t<this.length;t++)this.resetLine(t)},t.prototype.resetLine=function(t){var n=e.create();e.fromTranslation(n,[0,t]),this.setLine(t,n)},t.prototype.rotateLine=function(t,n){var r=pr(this.N(t));e.rotate(r,r,n),this.setLine(t,r)},t.prototype.scaleLine=function(t,n){if(!Array.isArray(n)||2!==n.length)throw new Error("Array should be [x, y]");var r=pr(this.N(t));e.scale(r,r,n),this.setLine(t,r)},t.prototype.setLine=function(t,n){if(t<0||t>=this.length)throw new Error("setLine: index "+t+" out of range");this.U=-1,this.buffer.set(n.subarray(0,8),8*t)},t.prototype.translateLine=function(t,n){if(!Array.isArray(n)||2!==n.length)throw new Error("Array should be [x, y]");var r=pr(this.N(t));e.translate(r,r,n),this.setLine(t,r)},t.prototype.transformVector=function(t,n){if(!Array.isArray(n)||2!==n.length)throw new Error("Array should be [x, y]");var r=o.create(),e=pr(this.N(t));return o.transformMat3(r,n,e),{x:r[0],y:r[1]}},t.prototype.transformVectorInverse=function(t,n){if(!Array.isArray(n)||2!==n.length)throw new Error("Array should be [x, y]");var r=o.create(),i=pr(this.N(t));return e.invert(i,i),o.transformMat3(r,n,i),{x:r[0],y:r[1]}},t.prototype.N=function(t){if(t<0||t>=this.length)throw new Error("getLine: index "+t+" out of range");return pr(this.buffer.subarray(8*t,8*t+8))},t}(),mr=function(){function t(t,n){this.targetPaletteNumber=n,this.targetPaletteIndex=t,this.length=m.h,this.buffer=new Float32Array(4*this.length)}return t.prototype.setAll=function(t){for(var n=0;n<this.length;n++)this.setLine(n,t)},t.prototype.setLine=function(t,n){if(t<0||t>=this.length)throw new Error("setLine: index "+t+" out of range");var r=D.a.extract(n,ar);this.buffer[4*t]=r.r/255,this.buffer[4*t+1]=r.g/255,this.buffer[4*t+2]=r.b/255},t}(),xr=function(){function t(t,n,r){var i=this;this.V=0,this.W=new lr("color","add",8947848,8947848),this.X=new lr("color","add",8947848,8947848),this.G=P("Opaque BG [BG]",cr),this.K=P("Transparent BG [TBG]",1),this.Y=S("Opaque sprites [OBJ0]",hr),this.H=S("Transparent sprites [OBJ1]",hr),this.J={peakOBJ:0,peakBG:0,peakVramWrites:0},this.Z=!0,this.$=0,this.tt=0,this.nt=0,this.rt=0,this.vec2=o,this.mat3=e,this.LineColorArray=mr,this.LineTransformationArray=dr,this.CopySource=ur,this.color=D.a,this.et(t),this.it();var u=this._;window.fetch("build/game.json").then(function(t){if(!t.ok)throw new Error("You need to build your project first; run `npm run convert-gfx`.");return t.json()}).then(function(t){if(i.ot=t,ar=i.at=t.info.paletteBpp,-1===[2,3,4,5,8].indexOf(i.at))throw new Error("Unsupported paletteBpp "+i.at);Promise.all([s(u,"build/sprites.png").then(function(t){i.S=t.texture,i.ut=function(t,n){var r=new Uint8Array(M(t,n.texture,0,0,n.width,n.height).buffer);return new B(r,n.width,n.height,4)}(u,t),i.ft=i.ut.clone(),Object(m.t)(t.width,t.height)}),s(u,"build/palettes.png").then(function(t){if(!(256===t.width&&64===t.height||16===t.width&&256===t.height))throw new Error("Mismatch in texture size (max {16,256}x256");i.O=t.texture,i.ct=function(t,n){var r=new Uint32Array(M(t,n.texture,0,0,n.width,n.height).buffer);return new B(r,n.width,n.height,1)}(u,t),i.ht=i.ct.clone(),8!==i.at&&i.ht.setPosterization(i.at),Object(m.r)(t.width,t.height)}),s(u,"build/maps.png").then(function(t){i.D=t.texture,i.st=function(t,n){var r=new Uint16Array(M(t,n.texture,0,0,n.width,n.height).buffer);return new B(r,n.width,n.height,2)}(u,t),i.lt=i.st.clone(),Object(m.q)(t.width,t.height)})]).then(function(){i.C=function(t,n,r){a||(a=t.getExtension("OES_texture_float"));var e=t.createTexture(),i=new Float32Array(n*r*4);return i.fill(0),t.bindTexture(t.TEXTURE_2D,e),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,n,r,0,t.RGBA,t.FLOAT,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),e}(u,m.e,m.d),i.configBackdropColor("#008"),i.configDisplay({extraSprites:!1}),function(t){var n=t._,r=h(n,"attribute vec4 aXyzp;\nattribute vec4 aMapInfo1;\nattribute vec4 aMapInfo2;\nattribute vec4 aMapInfo3;\nattribute vec4 aMapInfo4;\nuniform mat3 uModelViewMatrix;\nuniform mat4 uProjectionMatrix;\n\nvarying vec2 vTextureCoord;\nvarying float vPaletteNo;\n// TODO Florian -- use vec4 and extract in fragment program\nvarying highp vec2 vMapStart;\nvarying highp vec2 vMapSize;\nvarying vec2 vTilesetStart;\nvarying float vTilesetWidth;\nvarying vec2 vTileSize;\nvarying mat3 vTransformationMatrix;\n// [0] = linescroll buffer, if 0 use vTransformationMatrix always, [1] = whether to wrap around\nvarying vec2 vOtherInfo;\n\nuniform sampler2D uSamplerMaps, uSamplerSprites, uSamplerPalettes, uSamplerOthers;\n\nmat3 readLinescrollBuffer(int bufferNo, int horizOffset) {\n\tfloat vOfs = float(bufferNo) / "+m.d+".0;\n\tvec4 first = texture2D(uSamplerOthers, vec2(float(horizOffset) / "+m.e+".0, vOfs));\n\tvec4 second = texture2D(uSamplerOthers, vec2(float(horizOffset + 1) / "+m.e+".0, vOfs));\n\treturn mat3(\n\t\tfirst.xy, 0,\n\t\tvec2(first.a, second.r), 0,\n\t\tsecond.ba, 1.0);\n}\n\nvoid main(void) {\n\t// Only scale the final matrix (we can always say that the VDP supports fixed point math inside for matrix multiplication)\n\tgl_Position = uProjectionMatrix * vec4(floor(uModelViewMatrix * aXyzp.xyz), 1);\n\tvPaletteNo = floor(aXyzp.w);\n\tvMapStart = floor(aMapInfo1.xy);\n\tvTilesetStart = floor(aMapInfo1.zw);\n\tvMapSize = floor(aMapInfo2.xy);\n\tvTilesetWidth = floor(aMapInfo2.z);\n\tvTileSize = floor(aMapInfo3.xy);\n\tvTextureCoord = floor(aMapInfo3.zw);\n\tvOtherInfo = floor(aMapInfo4.xy);\n\t// If 0-255, use one transformation map-wide from the first line, if -1 never use transformations\n\tif (aMapInfo4.x >= 0.0 && aMapInfo4.x < 256.0) {\n\t\tvTransformationMatrix = readLinescrollBuffer(0, int(aMapInfo4.x) * 2);\n\t} else {\n\t\tvTransformationMatrix = mat3(\n\t\t\t1, 0, 0,\n\t\t\t0, 1, 0,\n\t\t\t0, 0, 1);\n\t}\n}\n","precision highp float;\n\nvarying highp vec2 vTextureCoord;\nvarying highp float vPaletteNo;\nvarying highp vec2 vMapStart;\nvarying highp vec2 vMapSize;varying vec2 vTilesetStart;\nvarying float vTilesetWidth;\nvarying vec2 vTileSize;\nvarying mat3 vTransformationMatrix;\nvarying vec2 vOtherInfo;\n\nuniform mat3 uModelViewMatrix;\nuniform vec4 uEnvColor, uColorSwaps;\nuniform sampler2D uSamplerMaps, uSamplerSprites, uSamplerPalettes, uSamplerOthers;\n\nint intDiv(float x, float y) {\n\treturn int(floor(x / y));\n}float modI(float a,float b) {\n\tfloat m=a-floor((a+0.5)/b)*b;\n\treturn floor(m+0.5);\n}\n\nmat3 readLinescrollBuffer(int bufferNo, int horizOffset) {\n\tfloat vOfs = float(bufferNo) / "+m.d+".0;\n\tvec4 first = texture2D(uSamplerOthers, vec2(float(horizOffset) / "+m.e+".0, vOfs));\n\tvec4 second = texture2D(uSamplerOthers, vec2(float(horizOffset + 1) / "+m.e+".0, vOfs));\n\treturn mat3(\n\t\tfirst.r, first.g, 0,\n\t\tfirst.a, second.r, 0,\n\t\tsecond.b, second.a, 1);\n}\n\nint readMap(int x, int y) {\n\tx = int(modI(float(x), vMapSize.x) + vMapStart.x);\n\ty = int(modI(float(y), vMapSize.y) + vMapStart.y);\n\n\tint texelId = x / 2;\n\tint texelC = x - texelId * 2;\n\tvec4 read = texture2D(uSamplerMaps, vec2(float(texelId) / "+m.b+".0, float(y) / "+m.a+".0));\n\tif (texelC == 0) return int(read.r * 255.0) + int(read.g * 255.0) * 256;\n\treturn int(read.b * 255.0) + int(read.a * 255.0) * 256;\n}\n\nvec2 positionInTexture(int tileNo) {\n\tvec2 base = vTilesetStart;\n\tfloat rowNo = float(tileNo / int(vTilesetWidth));\n\tfloat colNo = modI(float(tileNo), vTilesetWidth);\n\treturn base + vec2(colNo * vTileSize.x, rowNo * vTileSize.y);\n}\n\n"+Object(m.n)()+"\n"+Object(m.m)()+"\n\nvoid main(void) {\n\tmat3 transformationMatrix;\n\tfloat y = vTextureCoord.y;\n\t// Per-line info\n\tif (vOtherInfo.x >= 256.0) {\t\ttransformationMatrix = readLinescrollBuffer(int(vOtherInfo.x) - 256, int(y) * 2);\n\t\ty = 0.0;\n\t}\n\telse {\n\t\ttransformationMatrix = vTransformationMatrix;\n\t}\n\n\tvec2 texCoord = floor((transformationMatrix * vec3(vTextureCoord.x, y, 1)).xy);\tif (vOtherInfo.y < 1.0) {\n\t\tif (texCoord.x < 0.0) texCoord.x = 0.0;\n\t\tif (texCoord.y < 0.0) texCoord.y = 0.0;\n\t\tif (texCoord.x >= vTileSize.x * vMapSize.x) texCoord.x = vTileSize.x * vMapSize.x - 1.0;\n\t\tif (texCoord.y >= vTileSize.y * vMapSize.y) texCoord.y = vTileSize.y * vMapSize.y - 1.0;\n\t}\n\n\tint mapX = intDiv(texCoord.x, vTileSize.x), mapY = intDiv(texCoord.y, vTileSize.y);\n\tfloat basePalette = vPaletteNo;\n\tif (vPaletteNo >= "+m.f+".0) {\n\t\tbasePalette -= "+m.f+".0;\n\t}\tint mapTileNo = readMap(mapX, mapY);\tif (mapTileNo >= 65535) {\n\t\tdiscard;\n\t}\tint palOfs = mapTileNo / 8192;\n\tfloat paletteOffset = basePalette + float(palOfs);\n\tmapTileNo -= palOfs * 8192;\tvec2 offsetInTile = vec2(int(texCoord.x) - mapX * int(vTileSize.x), int(texCoord.y) - mapY * int(vTileSize.y));\n\tvec2 tilesetPos = positionInTexture(mapTileNo) + offsetInTile;\n\tfloat texel;\n\n\tif (vPaletteNo >= "+m.f+".0) {\n\t\ttexel = readTexel8(tilesetPos.x, tilesetPos.y);\n\t}\n\telse {\n\t\ttexel = readTexel4(tilesetPos.x, tilesetPos.y);\n\t}\n\n\tvec4 color = readPalette(texel, paletteOffset / "+m.g+".0);\n\tgl_FragColor = "+Object(m.p)("color")+";\n}");t.I={program:r,attribLocations:{xyzp:n.getAttribLocation(r,"aXyzp"),mapInfo1:n.getAttribLocation(r,"aMapInfo1"),mapInfo2:n.getAttribLocation(r,"aMapInfo2"),mapInfo3:n.getAttribLocation(r,"aMapInfo3"),mapInfo4:n.getAttribLocation(r,"aMapInfo4")},glBuffers:{xyzp:l(n),mapInfo1:l(n),mapInfo2:l(n),mapInfo3:l(n),mapInfo4:l(n)},uniformLocations:{colorSwaps:n.getUniformLocation(r,"uColorSwaps"),envColor:n.getUniformLocation(r,"uEnvColor"),projectionMatrix:n.getUniformLocation(r,"uProjectionMatrix"),modelViewMatrix:n.getUniformLocation(r,"uModelViewMatrix"),uSamplerMaps:n.getUniformLocation(r,"uSamplerMaps"),uSamplerSprites:n.getUniformLocation(r,"uSamplerSprites"),uSamplerPalettes:n.getUniformLocation(r,"uSamplerPalettes"),uSamplerOthers:n.getUniformLocation(r,"uSamplerOthers")}}}(i),function(t){var n=t._,r=h(n,"// The 3 first are the vertex position, the 4th is the palette ID\nattribute vec4 aXyzp;\n// The 2 first are the texture position\nattribute vec2 aUv;\n\nuniform mat3 uModelViewMatrix;\nuniform mat4 uProjectionMatrix;\n\nvarying highp vec2 vTextureCoord;\nvarying highp float vPaletteNo;\nuniform sampler2D uSamplerSprites, uSamplerPalettes;\n\nvoid main(void) {\n\t// Only scale the final matrix (we can always say that the VDP supports fixed point math inside for matrix multiplication)\n\tgl_Position = uProjectionMatrix * vec4(floor(uModelViewMatrix * vec3(aXyzp.xy, aXyzp.z)), 1);\n\tvPaletteNo = aXyzp.w;\n\tvTextureCoord = aUv;\n}","precision highp float;\n\nvarying highp vec2 vTextureCoord;\nvarying highp float vPaletteNo;\nuniform vec4 uEnvColor, uColorSwaps;\nuniform sampler2D uSamplerOthers, uSamplerSprites, uSamplerPalettes;\n\n"+Object(m.n)()+"\n"+Object(m.m)()+"\n\nvoid main(void) {\n\tfloat texel, palette;\n\tif (vPaletteNo >= "+m.f+".0) {\n\t\ttexel = readTexel8(vTextureCoord.x, vTextureCoord.y);\n\t\tpalette = (vPaletteNo - "+m.f+".0) / "+m.g+".0;\n\t}\n\telse {\n\t\ttexel = readTexel4(vTextureCoord.x, vTextureCoord.y);\n\t\tpalette = vPaletteNo / "+m.g+".0;\n\t}\n\n\tvec4 color = readPalette(texel, palette);\n\tgl_FragColor = "+Object(m.p)("color")+";\n}");t.M={program:r,attribLocations:{xyzp:n.getAttribLocation(r,"aXyzp"),uv:n.getAttribLocation(r,"aUv")},glBuffers:{xyzp:l(n),uv:l(n)},uniformLocations:{colorSwaps:n.getUniformLocation(r,"uColorSwaps"),envColor:n.getUniformLocation(r,"uEnvColor"),projectionMatrix:n.getUniformLocation(r,"uProjectionMatrix"),modelViewMatrix:n.getUniformLocation(r,"uModelViewMatrix"),uSamplerOthers:n.getUniformLocation(r,"uSamplerOthers"),uSamplerSprites:n.getUniformLocation(r,"uSamplerSprites"),uSamplerPalettes:n.getUniformLocation(r,"uSamplerPalettes")}}}(i),function(t){var n=t._,r=h(n,"\n\t\t\tattribute vec2 aXy;\n\t\t\tattribute vec4 aColor;\n\t\n\t\t\tuniform mat3 uModelViewMatrix;\n\t\t\tuniform mat4 uProjectionMatrix;\n\t\n\t\t\tvarying lowp vec4 vColor;\n\t\t\n\t\t\tvoid main(void) {\n\t\t\t\tvec4 pos = uProjectionMatrix * vec4(floor(uModelViewMatrix * vec3(aXy, 0)), 1);\n\t\t\t\tpos.z = 0.0;\n\t\t\t\tgl_Position = pos;\n\t\t\t\tvColor = aColor;\n\t\t\t}\n\t\t","precision highp float;\n    varying vec4 vColor;\n\t\tuniform vec4 uColorSwaps;\n\t\tuniform sampler2D uSamplerOthers, uSamplerPalettes;\n    \n    "+Object(m.m)(!1)+"\n\n    void main(void) {\n      if (vColor.a > 0.0) {\n\t      gl_FragColor = vColor;\n\t    } else {\n\t\t    vec4 color = readPalette(0.0, 0.0);\n\t\t\t\tgl_FragColor = vec4(color.rgb, 1.0);\n\t\t\t}\n    }\n  ");t.F={program:r,arrayBuffers:{xy:new Float32Array(8),color:new Float32Array(16)},attribLocations:{xy:n.getAttribLocation(r,"aXy"),color:n.getAttribLocation(r,"aColor")},glBuffers:{xy:l(n),color:l(n)},uniformLocations:{colorSwaps:n.getUniformLocation(r,"uColorSwaps"),projectionMatrix:n.getUniformLocation(r,"uProjectionMatrix"),modelViewMatrix:n.getUniformLocation(r,"uModelViewMatrix"),uSamplerOthers:n.getUniformLocation(r,"uSamplerOthers"),uSamplerPalettes:n.getUniformLocation(r,"uSamplerPalettes")}}}(i),r()})})}return t.prototype.configBackdropColor=function(t){var n=this.readPaletteMemory(0,0,1,1,ur.blank);n.array[0]=D.a.make(t),this.writePaletteMemory(0,0,1,1,n)},t.prototype.configBackgroundTransparency=function(t){if("add"!==t.op&&"sub"!==t.op)throw new Error("Invalid operation "+t.op);this.W.operation=t.op,this.W.blendSrc=D.a.posterize(D.a.make(t.blendSrc),this.at),this.W.blendDst=D.a.posterize(D.a.make(t.blendDst),this.at)},t.prototype.configColorSwap=function(t){var n=this;if(t.length>4)throw new Error("Can only swap up to 4 colors at a time");t.forEach(function(t,r){m.l[r]=t.targetPaletteNumber<<8|t.targetPaletteIndex,p(n._,n.C,0,r+m.c,t.buffer.length/4,1,t.buffer)});for(var r=t.length;r<4;r++)m.l[r]=-1},t.prototype.configDisplay=function(t){if(void 0===t&&(t={}),this.nt>0||this.tt>0)throw new Error("configDisplay must come at the beginning of your program/frame");er=(t.extraSprites?1:2)*this.screenWidth*this.screenHeight,or=t.extraSprites?512:256,ir=(t.extraSprites?2:1)*Math.ceil(this.screenWidth*this.screenHeight/(sr*sr))},t.prototype.configFade=function(t){var n=t.color||0;t.factor=Math.min(255,Math.max(0,t.factor)),this.V=16777215&D.a.make(n)|t.factor<<24},t.prototype.configObjectTransparency=function(t){if("add"!==t.op&&"sub"!==t.op)throw new Error("Invalid operation "+t.op);this.X.operation=t.op,this.X.blendSrc=D.a.posterize(D.a.make(t.blendSrc),this.at),this.X.blendDst=D.a.posterize(D.a.make(t.blendDst),this.at)},t.prototype.drawBackgroundTilemap=function(t,n){void 0===n&&(n={}),"string"==typeof t&&(t=this.map(t));var r=this.vt(n.hasOwnProperty("palette")?n.palette:t.designPalette),e=this.Mt(n.hasOwnProperty("tileset")?n.tileset:t.designTileset),i=n.hasOwnProperty("scrollX")?n.scrollX:0,o=n.hasOwnProperty("scrollY")?n.scrollY:0,a=n.hasOwnProperty("winX")?n.winX:0,u=n.hasOwnProperty("winY")?n.winY:0,f=n.hasOwnProperty("winW")?n.winW:m.i-a,c=n.hasOwnProperty("winH")?n.winH:m.h-u,h=!n.hasOwnProperty("wrap")||n.wrap,s=!!n.transparent,l=Math.floor(n.prio||(s?1:0)),v=s?this.K:this.G;if(l<0||l>15)throw new Error("Unsupported BG priority (0-15)");var M=_(a,u,a+f,u+c);if(M+this.tt>er)return fr&&console.log("Using too many BG pixels"),void(this.tt=er);this.tt+=M;var x=-1;if(n.lineTransform&&(x=n.lineTransform.U)<0){if(this.$>=2)return void(fr&&console.log("Only 2 LineTransformationArray are allowed"));n.lineTransform.U=x=256+this.$,p(this._,this.C,0,this.$++,n.lineTransform.buffer.length/4,1,n.lineTransform.buffer)}!function(t,n,r,e,i,o,a,u,f,c,h,s,l,v,M,p,x,w,y,_,b){if(void 0===y&&(y=-1),void 0===_&&(_=1),void 0===b&&(b=0),M+=h,p+=s,u=Math.floor(u/f),w&&(x|=m.f),t.usedVertices>=t.maxVertices)fr&&console.log(t.name+" overuse (max "+t.maxVertices/O+"), ignoring drawBackgroundTilemap");else{t.usedVertices+=O;var g=t.firstVertice;t.xyzp.set(d([h,s,b,x,h+l,s,b,x,h,s+v,b,x,h+l,s+v,b,x],4),4*g),t.mapInfo1.set(d([n,r,e,i,n,r,e,i,n,r,e,i,n,r,e,i],4),4*g),t.mapInfo2.set(d([o,a,u,0,o,a,u,0,o,a,u,0,o,a,u,0],4),4*g),t.mapInfo3.set(d([f,c,M,p,f,c,M+l,p,f,c,M,p+v,f,c,M+l,p+v],4),4*g),t.mapInfo4.set(d([y,_,0,0,y,_,0,0,y,_,0,0,y,_,0,0],4),4*g)}}(v,t.x,t.y,e.x,e.y,t.w,t.h,e.w,e.tw,e.th,a,u,f,c,i,o,r.y,e.hiColor,x,h?1:0,l)},t.prototype.drawObject=function(t,n,r,e){void 0===e&&(e={}),"string"==typeof t&&(t=this.sprite(t));var i=this.vt(e.hasOwnProperty("palette")?e.palette:t.designPalette),o=e.hasOwnProperty("width")?e.width:t.w,a=e.hasOwnProperty("height")?e.height:t.h,u=Math.floor(e.prio||(e.transparent?2:1)),f=e.transparent?this.H:this.Y,c=Math.floor(t.x),h=Math.floor(t.y);if(u<0||u>15)throw new Error("Unsupported object priority (0-15)");if(this.Y.usedSprites+this.H.usedSprites>=or)fr&&console.log("Using too many objects (max "+or);else{var s=_(n,r,n+o,r+a,!0);if(s+this.nt>ir){if(fr&&console.log("Using too many OBJ pixels"),this.nt>=ir)return;var l=_(0,r,sr,r+a,!0),v=ir-this.nt,M=Math.floor(v/l)*sr;return g(f,n,r,n+M,r+a,c,h,c+t.w*M/o,h+Math.floor(t.h),i.y,t.hiColor,u,e.flipH,e.flipV),void(this.nt=ir)}this.nt+=s,g(f,n,r,n+o,r+a,c,h,c+Math.floor(t.w),h+Math.floor(t.h),i.y,t.hiColor,u,e.flipH,e.flipV)}},t.prototype.map=function(t){var n=this.ot.maps[t];if(!n)throw new Error("Map "+t+" not found");return new E(n.x,n.y,n.w,n.h,n.til,n.pal)},t.prototype.palette=function(t){var n=this.ot.pals[t];if(!n)throw new Error("Palette "+t+" not found");return new A(n.y,n.w,n.h)},t.prototype.readMap=function(t,n){void 0===n&&(n=ur.current);var r=this.pt(t),e=new Uint16Array(r.w*r.h);return n===ur.current&&this.lt.readToBuffer(r.x,r.y,r.w,r.h,e),n===ur.rom&&this.st.readToBuffer(r.x,r.y,r.w,r.h,e),new j(e,r.w,r.h)},t.prototype.readPalette=function(t,n){void 0===n&&(n=ur.current);var r=this.vt(t);return this.readPaletteMemory(0,r.y,r.w,r.h,n)},t.prototype.readPaletteMemory=function(t,n,r,e,i){void 0===i&&(i=ur.current);var o=new Uint32Array(r*e);return i===ur.current&&this.ht.readToBuffer(t,n,r,e,o),i===ur.rom&&this.ct.readToBuffer(t,n,r,e,o),new j(o,r,e)},t.prototype.readSprite=function(t,n){void 0===n&&(n=ur.current);var r=this.Mt(t);if(!r.hiColor&&r.x%2!=0)throw new Error("Lo-color sprites need to be aligned to 2 pixels");var e=r.hiColor?r.x:r.x/2,i=r.hiColor?r.w:Math.ceil(r.w/2),o=new Uint8Array(i*r.h);return n===ur.current&&this.ft.readToBuffer(e,r.y,i,r.h,o),n===ur.rom&&this.ut.readToBuffer(e,r.y,i,r.h,o),new j(o,i,r.h)},Object.defineProperty(t.prototype,"screenHeight",{get:function(){return m.h},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"screenWidth",{get:function(){return m.i},enumerable:!0,configurable:!0}),t.prototype.sprite=function(t){var n=this.ot.sprites[t];if(!n)throw new Error("Sprite "+t+" not found");return new z(n.x,n.y,n.w,n.h,n.tw,n.th,n.tiles,n.hicol,n.pal)},t.prototype.writeMap=function(t,n){var r=this.pt(t);this.lt.writeTo(r.x,r.y,r.w,r.h,n.array),this.lt.syncToVramTexture(this._,this.D,r.x,r.y,r.w,r.h),this.rt+=r.w*r.h},t.prototype.writePalette=function(t,n){var r=this.vt(t);this.writePaletteMemory(0,r.y,r.w,r.h,n)},t.prototype.writePaletteMemory=function(t,n,r,e,i){this.ht.writeTo(t,n,r,e,i.array),this.ht.syncToVramTexture(this._,this.O,t,n,r,e),this.rt+=r*e},t.prototype.writeSprite=function(t,n){var r=this.Mt(t);if(!r.hiColor&&r.x%2!=0)throw new Error("Lo-color sprites need to be aligned to 2 pixels");var e=r.hiColor?r.x:r.x/2,i=r.hiColor?r.w:Math.ceil(r.w/2);this.ft.writeTo(e,r.y,i,r.h,n.array),this.ft.syncToVramTexture(this._,this.S,e,r.y,i,r.h),this.rt+=i*r.h},t.prototype.dt=function(t){var n=this._,r=t.effect,e=t.blendSrc,i=t.blendDst,o=t.operation;if(m.o[0]=m.o[1]=m.o[2]=m.o[3]=1,n.blendEquation("sub"===o?n.FUNC_REVERSE_SUBTRACT:n.FUNC_ADD),"blend"===r)n.enable(n.BLEND),n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA);else if("premult"===r)n.enable(n.BLEND),n.blendFunc(n.ONE,n.ONE_MINUS_SRC_ALPHA);else if("color"===r){var a=D.a.extract(i,this.at),u=D.a.extract(e,this.at);n.blendColor(a.r/255,a.g/255,a.b/255,a.a/255),m.o[0]=u.r/255,m.o[1]=u.g/255,m.o[2]=u.b/255,m.o[3]=u.a/255,n.blendFunc(n.SRC_ALPHA,n.CONSTANT_COLOR),n.enable(n.BLEND)}else n.disable(n.BLEND)},t.prototype.xt=function(){this.J.peakBG=Math.max(this.J.peakBG,this.tt/(this.screenWidth*this.screenHeight)),this.J.peakOBJ=Math.max(this.J.peakOBJ,this.nt)},t.prototype.wt=function(){var t=this._;fr&&this.xt(),this.Z&&(t.clearColor(0,0,0,0),m.k?(t.clearDepth(1),t.clear(t.DEPTH_BUFFER_BIT|t.COLOR_BUFFER_BIT)):t.clear(t.COLOR_BUFFER_BIT),t.disable(t.DEPTH_TEST),I(this,0,0,m.i,m.h,0,0,0,0),this.Z=!1,m.k&&(t.depthFunc(t.LESS),t.enable(t.DEPTH_TEST))),this.dt(vr),T(this,this.G),b(this,this.Y,0,this.Y.usedSprites);var n=this.H.sort(this.K.getZOfBG(0));this.dt(this.X),b(this,this.H,0,n),this.dt(this.W),T(this,this.K),this.dt(this.X),b(this,this.H,n,this.H.usedSprites),this.Y.reset(),this.H.reset(),this.$=this.nt=this.tt=0},t.prototype.yt=function(){this.wt();var t=D.a.extract(this.V,this.at),n=t.r,r=t.g,e=t.b,i=t.a;if(i>0){var o=this._;this.dt(Mr),o.disable(o.DEPTH_TEST),I(this,0,0,m.i,m.h,n/255,r/255,e/255,i/255)}var a=Math.min(30,Math.ceil(this.rt/2048));return fr&&a>1&&console.log("Overuse of VRAM writes for this frame ("+this.rt+"/2048), slowing down "+a+"x"),this.J.peakVramWrites=Math.max(this.J.peakVramWrites,this.rt),this.rt=0,a},t.prototype.pt=function(t){return"string"==typeof t?this.map(t):t},t.prototype.vt=function(t){return"string"==typeof t?this.palette(t):t},t.prototype.Mt=function(t){return"string"==typeof t?this.sprite(t):t},t.prototype._t=function(){var t=this.J;return this.J={peakOBJ:0,peakBG:0,peakVramWrites:0},t},t.prototype.et=function(t){this._=t.getContext("webgl",{premultipliedAlpha:!0,alpha:m.j,antialias:!1}),null===this._&&alert("Unable to initialize WebGL. Your browser or machine may not support it.")},t.prototype.it=function(){this.T=i.create(),i.ortho(this.T,0,m.i,m.h,0,-16,16),this.P=e.create()},t.prototype.bt=function(){this.Z=!0},t}()},function(t,n,r){"use strict";var e,i,o=r(0),a=r(2),u=59.94,f=1/(u+1),c=1/u,h=1/(u-1),s=30,l=function(){function t(){this.last=0,this.late=0,this.framerateSum=c*s}return t.prototype.doForSmoothness=function(t){var n=this.gt(t);if(this.St(n),n>h?(this.late+=n-h,this.late>.25&&(this.late=0)):n<f&&(this.late+=n-f),this.last=t,this.late<=-c)return this.late+=c,0;if(this.late>=c){var r=Math.floor(this.late/c);return this.late-=r*c,1+r}return 1},t.prototype.doSimplest=function(t){var n=this.gt(t);return this.St(n),this.last=t,1},t.prototype.doStandard=function(t){var n=this.gt(t);if(this.St(n),this.late+=n-c,this.late>.25&&(this.late=0),this.last=t,this.late>=c){var r=Math.floor(this.late/c);return this.late-=r*c,1+r}return this.late<=-c?(this.late+=c,0):1},t.prototype.getFramerate=function(){return s/this.framerateSum},t.prototype.St=function(t){t<.25&&(this.framerateSum=this.framerateSum*(s-1)/s+t)},t.prototype.gt=function(t){return(t-this.last)/1e3},t}();!function(t){t[t.Up=0]="Up",t[t.Down=1]="Down",t[t.Left=2]="Left",t[t.Right=3]="Right",t[t.A=4]="A",t[t.B=5]="B",t[t.L=6]="L",t[t.R=7]="R",t[t.Start=8]="Start",t[t.Select=9]="Select",t[t.NumKeys=10]="NumKeys"}(e||(e={})),function(t){t[t.Up=0]="Up",t[t.Released=1]="Released",t[t.Down=2]="Down",t[t.Pressed=3]="Pressed"}(i||(i={}));var v={ArrowUp:e.Up,ArrowDown:e.Down,ArrowLeft:e.Left,ArrowRight:e.Right,w:e.Up,s:e.Down,a:e.Left,d:e.Right,j:e.A,k:e.B,h:e.L,l:e.R,c:e.A,v:e.B,x:e.L,b:e.R," ":e.Select,Enter:e.Start},M=function(){function t(){this.Key=e;var t=this;this.keyState=new Array(e.NumKeys).fill(i.Up),document.onkeydown=function(n){var r=t.Ot(n);r>=0&&!t.isDown(r)&&(t.keyState[r]=i.Pressed)},document.onkeyup=function(n){var r=t.Ot(n);r>=0&&(t.keyState[r]=i.Released)}}return t.prototype.hasToggledDown=function(t){return this.keyState[t]===i.Pressed},t.prototype.hasToggledUp=function(t){return this.keyState[t]===i.Released},t.prototype.isDown=function(t){return this.keyState[t]>=i.Down},t.prototype.Ct=function(){var t=this;this.keyState.forEach(function(n,r){n===i.Pressed&&(t.keyState[r]=i.Down),n===i.Released&&(t.keyState[r]=i.Up)})},t.prototype.Ot=function(t){return t.key in v?v[t.key]:-1},t}();function p(t,n){return Object(o.s)(t.width,t.height,!1),new Promise(function(r){var e=new a.c(t,n,function(){e.bt(),e.input=new M,r(e)})})}function d(t,n){var r=0,e=[],i=new l,o=0,f=0,c=1;window.requestAnimationFrame(function h(s){if(a.a){var l=Math.floor(s/1e3);l!==r&&e.length>0&&(console.log("Upd="+(e.reduce(function(t,n){return t+n})/e.length).toFixed(3)+"ms; r="+o+", s="+f+", u="+e.length+"; "+i.getFramerate().toFixed(2)+"Hz",t._t()),e.length=0,o=f=0),r=l}var v,M=i.getFramerate();v=M>=u-1&&M<=u+1?i.doSimplest(s):i.doStandard(s);for(var p=0;p<v;p++)if(!(c-- >1)){var d=window.performance.now();t.bt(),n.next(),c=t.yt(),e.push(window.performance.now()-d)}a.a&&(v>0&&(o+=1),v>1&&(f+=v-1)),window.requestAnimationFrame(h),t.input.Ct()})}r.d(n,"a",function(){return p}),r.d(n,"b",function(){return d})},,,,,,,function(t,n,r){t.exports=r(11)},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"vdp",function(){return vdp}),__webpack_require__.d(__webpack_exports__,"startStandalone",function(){return startStandalone}),__webpack_require__.d(__webpack_exports__,"startGame",function(){return startGame});var _vdp_runloop__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(3),_vdp_vdp__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(2);__webpack_require__.d(__webpack_exports__,"VDP",function(){return _vdp_vdp__WEBPACK_IMPORTED_MODULE_1__.c});var _vdp_color__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(1);__webpack_require__.d(__webpack_exports__,"color",function(){return _vdp_color__WEBPACK_IMPORTED_MODULE_2__.a});var __read=function(t,n){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var e,i,o=r.call(t),a=[];try{for(;(void 0===n||n-- >0)&&!(e=o.next()).done;)a.push(e.value)}catch(t){i={error:t}}finally{try{e&&!e.done&&(r=o.return)&&r.call(o)}finally{if(i)throw i.error}}return a},vdp;function startStandalone(resourceDirectory,scriptFile){Promise.all([window.fetch(scriptFile).then(function(t){if(!t.ok)throw new Error(scriptFile+" not found");return t.text()}),Object(_vdp_runloop__WEBPACK_IMPORTED_MODULE_0__.a)(document.querySelector("#glCanvas"),resourceDirectory)]).then(function(_a){var _b=__read(_a,2),code=_b[0],vdp=_b[1];code=code.replace(/^import .*?;/gm,""),code="(function(vdp){var window ='Please play fair';"+code+";return main;})";var mainFunc=eval(code)(vdp);if(!mainFunc)throw new Error("Check that your script contains a function *main()");Object(_vdp_runloop__WEBPACK_IMPORTED_MODULE_0__.b)(vdp,mainFunc())})}function startGame(t,n){Object(_vdp_runloop__WEBPACK_IMPORTED_MODULE_0__.a)(document.querySelector(t),"./build").then(function(t){window.vdp=t,vdp=t,Object(_vdp_runloop__WEBPACK_IMPORTED_MODULE_0__.b)(t,n(t))})}}])});